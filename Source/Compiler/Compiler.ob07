(*
   Copyright 2013 Krotov Anton

   This file is part of Compiler.

   Compiler is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   Compiler is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with Compiler. If not, see <http://www.gnu.org/licenses/>.
   *)
ÌÎÄÓËÜ Compiler;

ÈÌÏÎÐÒ ìÄåöë := ìîäÄåöë,
   ìÑêàí := ìîäÑêàíåð,
   ìÓòèëü := ìîäÓòèëü,
   X86 := ìîäÀñì86_32,
   mSys := SYSTEM,
   ìÇâåíî := ìîäÇâåíî,
   ìÒèï := ìîäÒèï,
   ìÊîíñò := ìîäÊîíñòàíòû,
   ìÊîíñ := ìîäÊîíñîëü,
   ìÎø := ìîäÎøèáêè,
   ìÎøÊîíñò := ìîäÎøèáêèÊîíñò,
   ìÏðîö := ìîäÏðîöåññ,
   ìÑòð := ìîäÑòðîêè,
   ìÖåïü := ìîäÖåïü,
   ìÏðîâ := ìîäÏðîâåðêà,
   ìÓçåë := ìîäÓçåë,
   ìÂèíÊîíñ := ìîäÂèíÊîíñîëü,
   ìÑòåê := ìîäÑòåê,
   ìÎÑ := ìîäÎÑ,
   ìÔàéë := ìîäÔàéë,
   ìÏàì := ìîäÏàìÿòü;

ÊÎÍÑÒ

   lxEOF = 0; lxINT = -1; lxREAL = -2; lxSTRING = -3; lxIDENT = -4; lxHEX = -5; lxCHX = -6; lxLONGREAL = -7;
   lxBY = 3; lxDIV = 6;
   lxMOD = 17; 

   lxLRound = 60; lxCaret = 63;
   lxRCurly = 66; lxDot = 67; lxDbl = 68; lxAssign = 69;
   lxLE = 75; lxGE = 76;

   eVAR = 1; eCONST = 2; eEXP = 3; ePROC = 4; eSTPROC = 5; eSYSPROC = 6;

   IDMOD = 1; IDCONST = 2; IDTYPE = 3; IDVAR = 4; IDPROC = 5; IDSTPROC = 6; IDGUARD = 7; IDPARAM = 8; IDSYSPROC = 9;

ÒÈÏÛ

   òÌåòêà = ÓÊÀÇÀÒÅËÜ ÍÀ ÇÀÏÈÑÜ (ìÇâåíî.òÇâåíî)
         a, b: ÖÅËÎÅ
      ÊÎÍÅÖ;

ÏÅÐÅÌ
   ïÂûðàæ, pFactor: ÏÐÎÖÅÄÓÐÀ (ÏÅÐ e: ìÄåöë.òÂûðàæåíèå);
   pOpSeq: ÏÐÎÖÅÄÓÐÀ;
   ñòðÑóùí: ìÑòð.òÑòðîêà;
   sttypes: ìÄåöë.òóÒèïÍàáîð;

ÏÐÎÖÅÄÓÐÀ Âûðàæ_Çàãðóçèòü(âûðàæ_: ìÄåöë.òÂûðàæåíèå);
   ÍÀ×ÀËÎ
      ÅÑËÈ âûðàæ_.eType = eVAR ÒÎÃÄÀ
         X86.Load(âûðàæ_.T.òèï_íîì)
      ÊÎÍÅÖ
   ÊÎÍÅÖ Âûðàæ_Çàãðóçèòü;

ÏÐÎÖÅÄÓÐÀ Ñòð_Äëèíà(àäð_: ÄËÈÍÂÅÙ): ÖÅËÎÅ;
   ÏÅÐÅÌ
      ñòð: ìÄåöë.òóÊîíñòÑòð;
   ÍÀ×ÀËÎ
      ñòð := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(àäð_)
      ÂÅÐÍÓÒÜ ñòð.äëèíà
   ÊÎÍÅÖ Ñòð_Äëèíà;

ÏÐÎÖÅÄÓÐÀ BaseOf(òèï0_, òèï1_: ìÒèï.òóÒèï): ÁÓËÅÂÎ;
   ÏÅÐÅÌ
      òèïû_ðàâíû, òèï0_óêàçàòåëü: ÁÓËÅÂÎ;
   ÍÀ×ÀËÎ
      òèïû_ðàâíû := (òèï0_.òèï_íîì = òèï1_.òèï_íîì);
      òèï0_óêàçàòåëü := (òèï0_.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ);
        
      ÅÑËÈ òèïû_ðàâíû & (òèï0_.òèï_íîì Â {ìÊîíñò.òèïÇÀÏÈÑÜ, ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ}) ÒÎÃÄÀ
         ÅÑËÈ òèï0_óêàçàòåëü ÒÎÃÄÀ
            òèï0_ := òèï0_.Base;
            òèï1_ := òèï1_.Base
         ÊÎÍÅÖ;
         ÏÎÊÀ (òèï1_ # ÏÓÑÒÎ) & (òèï1_ # òèï0_) ÄÅËÀÒÜ
            òèï1_ := òèï1_.Base
         ÊÎÍÅÖ
      ÊÎÍÅÖ
      ÂÅÐÍÓÒÜ òèï0_ = òèï1_
   ÊÎÍÅÖ BaseOf;

ÏÐÎÖÅÄÓÐÀ Designator(ÏÅÐ âûðàæ_: ìÄåöë.òÂûðàæåíèå);
   ÏÅÐÅÌ
      id: ìÄåöë.òóÑóùíîñòü;
      óÓçåë: ìÓçåë.òóÓçåë;
      âûðàæåíèå: ìÄåöë.òÂûðàæåíèå;
      öÑòðîêà, col, i, n, bases, glob, loc, idx: ÖÅËÎÅ;
      imp, áÎñòàíîâ, áÎõðàíà: ÁÓËÅÂÎ;
      óÏîëå: ìÄåöë.òóÏîëå;
      óÒèï, BaseT: ìÒèï.òóÒèï;
      óÑòð: ìÄåöë.òóÊîíñòÑòð;

   ÏÐÎÖÅÄÓÐÀ LoadVar;
      ÍÀ×ÀËÎ
         ÅÑËÈ glob # -1 ÒÎÃÄÀ
            X86.GlobalAdr(glob);
            glob := -1
         ÀÅÑËÈ loc # -1 ÒÎÃÄÀ
            X86.LocalAdr(loc, bases);
            loc := -1
         ÊÎÍÅÖ
      ÊÎÍÅÖ LoadVar;

   ÍÀ×ÀËÎ
      glob := -1;
      loc := -1;
      ìÄåöë.Êîîðä_Óñò(öÑòðîêà, col);
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxIDENT);
      óÓçåë := ìÑêàí.id;
      id := ìÄåöë.GetIdent(óÓçåë);
      ÅÑËÈ (id # ÏÓÑÒÎ) & (id.iType = IDMOD) ÒÎÃÄÀ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxDot);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxIDENT);
         ìÄåöë.Êîîðä_Óñò(öÑòðîêà, col);
         óÓçåë := ìÑêàí.id;
         imp := id.ìîäóëü # ìÄåöë.ìîäóëü;
         id := ìÄåöë.GetQIdent(id.ìîäóëü, óÓçåë)
      ÊÎÍÅÖ;
      ìÏðîâ.Òåñò(id # ÏÓÑÒÎ, öÑòðîêà, col, 42);
      âûðàæ_.vparam := ËÎÆÜ;
      âûðàæ_.deref := ËÎÆÜ;
      âûðàæ_.id := id;
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ÂÛÁÎÐ id.iType ÈÇ
         |IDVAR:
            âûðàæ_.eType := eVAR;
            âûðàæ_.T := id.T;
            ÅÑËÈ id.VarKind = 0 ÒÎÃÄÀ
               âûðàæ_.Read := imp
            ÈÍÀ×Å
               âûðàæ_.Read := (id.VarKind = ìÄåöë.param) & (id.T.òèï_íîì Â {ìÊîíñò.òèïÇÀÏÈÑÜ, ìÊîíñò.òèïÌÀÑÑÈÂ});
               âûðàæ_.vparam := id.VarKind = ìÄåöë.paramvar
            ÊÎÍÅÖ;
            bases := ìÄåöë.ìîäóëü.óðîâåíü - id.Level;
            ÅÑËÈ id.Level = 3 ÒÎÃÄÀ
               glob := id.Offset
            ÀÅÑËÈ (id.VarKind = 0) ÈËÈ (id.VarKind = ìÄåöë.param) & ~(id.T.òèï_íîì Â {ìÊîíñò.òèïÌÀÑÑÈÂ, ìÊîíñò.òèïÇÀÏÈÑÜ}) ÒÎÃÄÀ
               loc := id.Offset
            ÀÅÑËÈ (id.VarKind = ìÄåöë.paramvar) ÈËÈ (id.T.òèï_íîì Â {ìÊîíñò.òèïÌÀÑÑÈÂ, ìÊîíñò.òèïÇÀÏÈÑÜ}) ÒÎÃÄÀ
               ÅÑËÈ ìÄåöë.Dim(âûðàæ_.T) > 0 ÒÎÃÄÀ
                  n := ìÄåöë.Dim(âûðàæ_.T);
                  ÄËß i := n ÄÎ 1 ÏÎ -1 ÄÅËÀÒÜ
                     X86.LocalAdr(id.Offset + i * 4, bases);
                     X86.Load(ìÊîíñò.òèïÖÅËÎÅ)
                  ÊÎÍÅÖ
               ÊÎÍÅÖ;
               X86.LocalAdr(id.Offset, bases);
               X86.Load(ìÊîíñò.òèïÖÅËÎÅ)
            ÊÎÍÅÖ
         |IDCONST:
            ìÏðîâ.Òåñò(id.T # ÏÓÑÒÎ, öÑòðîêà, col, 75);
            âûðàæ_.eType := eCONST;
            âûðàæ_.T := id.T;
            âûðàæ_.Value := id.Value;
            ÅÑËÈ id.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÁÓËÅÂÎ} ÒÎÃÄÀ
                X86.PushConst(ÊÖÅË(âûðàæ_.Value))
            ÀÅÑËÈ id.T.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ} ÒÎÃÄÀ
                X86.PushFlt(âûðàæ_.Value)
            ÀÅÑËÈ id.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
                óÑòð := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(âûðàæ_.Value);
                ÅÑËÈ óÑòð.äëèíà = 1 ÒÎÃÄÀ
                    X86.PushConst(ÍËÈÒ(óÑòð.ñòð[0]))
                ÈÍÀ×Å
                    X86.PushInt(óÑòð.íîìåð)
                ÊÎÍÅÖ
            ÊÎÍÅÖ
         |IDPROC:
            âûðàæ_.eType := ePROC;
            âûðàæ_.T := sttypes[ìÊîíñò.TVOID]
         |IDTYPE:
            ìÏðîâ.Òåñò(ËÎÆÜ, öÑòðîêà, col, 101)
         |IDSTPROC:
            âûðàæ_.eType := eSTPROC;
            âûðàæ_.T := sttypes[ìÊîíñò.TVOID]
         |IDSYSPROC:
            âûðàæ_.eType := eSYSPROC;
            âûðàæ_.T := sttypes[ìÊîíñò.TVOID]
      ÈÍÀ×Å
      ÊÎÍÅÖ;
      áÎñòàíîâ := ËÎÆÜ;
      áÎõðàíà := ËÎÆÜ;
      ÏÎÂÒÎÐßÒÜ
         ÂÛÁÎÐ ìÑêàí.ñóùíîñòü ÈÇ
            |lxDot:
               âûðàæ_.deref := ËÎÆÜ;
               ìÏðîâ.Òåñò2(âûðàæ_.T.òèï_íîì Â {ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, ìÊîíñò.òèïÇÀÏÈÑÜ}, 105);
               ÅÑËÈ âûðàæ_.T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ ÒÎÃÄÀ
                  âûðàæ_.Read := ËÎÆÜ;
                  LoadVar;
                  âûðàæ_.T := âûðàæ_.T.Base;
                  X86.Load(ìÊîíñò.òèïÖÅËÎÅ);
                  ÅÑËÈ ~áÎõðàíà ÒÎÃÄÀ
                     X86.CheckNIL
                  ÊÎÍÅÖ
               ÊÎÍÅÖ;
               ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
               ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxIDENT);
               ìÄåöë.Êîîðä_Óñò(öÑòðîêà, col);
               óÓçåë := ìÑêàí.id;
               óÒèï := âûðàæ_.T;
               ÏÎÂÒÎÐßÒÜ
                  óÏîëå := ìÄåöë.GetField(óÒèï, óÓçåë);
                  óÒèï := óÒèï.Base
               ÏÎÊÀÍÅ (óÏîëå # ÏÓÑÒÎ) ÈËÈ (óÒèï = ÏÓÑÒÎ);
               ìÏðîâ.Òåñò(óÏîëå # ÏÓÑÒÎ, öÑòðîêà, col, 99);
               ÅÑËÈ óÏîëå.Unit # ìÄåöë.ìîäóëü ÒÎÃÄÀ
                  ìÏðîâ.Òåñò(óÏîëå.Export, öÑòðîêà, col, 99)
               ÊÎÍÅÖ;
               ÅÑËÈ glob # -1 ÒÎÃÄÀ
                  glob := glob + óÏîëå.Offset
               ÀÅÑËÈ loc # -1 ÒÎÃÄÀ
                  loc := loc + óÏîëå.Offset
               ÈÍÀ×Å
                  X86.Field(óÏîëå.Offset)
               ÊÎÍÅÖ;
               âûðàæ_.T := óÏîëå.T;
               âûðàæ_.vparam := ËÎÆÜ;
               áÎõðàíà := ËÎÆÜ;
               ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
            |ìÊîíñò.îïÑêîáêàËåâÊâ:
               LoadVar;
               ÏÎÂÒÎÐßÒÜ
                  ìÏðîâ.Òåñò2(âûðàæ_.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ, 102);
                  ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
                  ìÄåöë.Êîîðä_Óñò(öÑòðîêà, col);
                  ïÂûðàæ(âûðàæåíèå);
                  ìÏðîâ.Òåñò(âûðàæåíèå.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, öÑòðîêà, col, 52);
                  Âûðàæ_Çàãðóçèòü(âûðàæåíèå);
                  ÅÑËÈ âûðàæ_.T.äëèíà = 0 ÒÎÃÄÀ
                     BaseT := ìÄåöë.OpenBase(âûðàæ_.T);
                     X86.PushConst(BaseT.ðàçìåð);
                     X86.OpenIdx(ìÄåöë.Dim(âûðàæ_.T))
                  ÈÍÀ×Å
                     ÅÑËÈ âûðàæåíèå.eType = eCONST ÒÎÃÄÀ
                        idx := ÊÖÅË(âûðàæåíèå.Value);
                        ìÏðîâ.Òåñò((idx >= 0) & (idx < âûðàæ_.T.äëèíà), öÑòðîêà, col, 159);
                        ÅÑËÈ âûðàæ_.T.Base.ðàçìåð # 1 ÒÎÃÄÀ
                           X86.Drop;
                           X86.PushConst(âûðàæ_.T.Base.ðàçìåð * idx)
                        ÊÎÍÅÖ;
                        X86.Idx
                     ÈÍÀ×Å
                        X86.FixIdx(âûðàæ_.T.äëèíà, âûðàæ_.T.Base.ðàçìåð)
                     ÊÎÍÅÖ
                  ÊÎÍÅÖ;
                  âûðàæ_.T := âûðàæ_.T.Base
               ÏÎÊÀÍÅ ìÑêàí.ñóùíîñòü # ìÊîíñò.îïÇàïÿòàÿ;
               ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÑêîáêàÏðÊâ);
               âûðàæ_.vparam := ËÎÆÜ;
               áÎõðàíà := ËÎÆÜ;
               ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
            |lxCaret:
               LoadVar;
               ìÏðîâ.Òåñò2(âûðàæ_.T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, 104);
               âûðàæ_.Read := ËÎÆÜ;
               X86.Load(ìÊîíñò.òèïÖÅËÎÅ);
               ÅÑËÈ ~áÎõðàíà ÒÎÃÄÀ
                  X86.CheckNIL
               ÊÎÍÅÖ;
               âûðàæ_.T := âûðàæ_.T.Base;
               âûðàæ_.vparam := ËÎÆÜ;
               âûðàæ_.deref := ÈÑÒÈÍÀ;
               áÎõðàíà := ËÎÆÜ;
               ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
            |lxLRound:
               LoadVar;
               ÅÑËÈ âûðàæ_.T.òèï_íîì Â {ìÊîíñò.òèïÇÀÏÈÑÜ, ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ} ÒÎÃÄÀ
                  ÅÑËÈ âûðàæ_.T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ ÒÎÃÄÀ
                     ìÏðîâ.Òåñò2(âûðàæ_.vparam, 108)
                  ÊÎÍÅÖ;
                  ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
                  ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxIDENT);
                  ìÄåöë.Êîîðä_Óñò(öÑòðîêà, col);
                  óÒèï := ìÄåöë.IdType(öÑòðîêà, col);
                  ìÏðîâ.Òåñò(óÒèï # ÏÓÑÒÎ, öÑòðîêà, col, 42);
                  ÅÑËÈ âûðàæ_.T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ ÒÎÃÄÀ
                     ìÏðîâ.Òåñò(óÒèï.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ, öÑòðîêà, col, 106)
                  ÈÍÀ×Å
                     ìÏðîâ.Òåñò(óÒèï.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, öÑòðîêà, col, 107)
                  ÊÎÍÅÖ;
                  ìÏðîâ.Òåñò(BaseOf(âûðàæ_.T, óÒèï), öÑòðîêà, col, 108);
                  âûðàæ_.T := óÒèï;
                  ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÑêîáêàÏðÊð);
                  ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
                  ÅÑËÈ âûðàæ_.T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ ÒÎÃÄÀ
                     ÅÑËÈ (ìÑêàí.ñóùíîñòü = lxDot) ÈËÈ (ìÑêàí.ñóùíîñòü = lxCaret) ÒÎÃÄÀ
                        X86.DupLoadCheck
                     ÈÍÀ×Å
                        X86.DupLoad
                     ÊÎÍÅÖ;
                     áÎõðàíà := ÈÑÒÈÍÀ;
                     óÒèï := óÒèï.Base
                  ÈÍÀ×Å
                     X86.LocalAdr(âûðàæ_.id.Offset, ìÄåöë.ìîäóëü.óðîâåíü - âûðàæ_.id.Level)
                  ÊÎÍÅÖ;
                  X86.Guard(óÒèï.íîìåð, ËÎÆÜ)
               ÈÍÀ×Å
                  áÎñòàíîâ := ÈÑÒÈÍÀ
               ÊÎÍÅÖ
         ÈÍÀ×Å
            áÎñòàíîâ := ÈÑÒÈÍÀ
         ÊÎÍÅÖ
      ÏÎÊÀÍÅ áÎñòàíîâ;
      LoadVar
   ÊÎÍÅÖ Designator;

ÏÐÎÖÅÄÓÐÀ Set(ÏÅÐ e: ìÄåöë.òÂûðàæåíèå);
   ÏÅÐÅÌ
      a, b: ìÄåöë.òÂûðàæåíèå;
      line, col: ÖÅËÎÅ;
      s: SET; flag: ÁÓËÅÂÎ;
   ÍÀ×ÀËÎ
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      e.eType := eEXP;
      e.T := sttypes[ìÊîíñò.òèïÍÀÁÎÐ];
      e.Value := 0.0D0;
      e.vparam := ËÎÆÜ;
      s := {};
      flag := ÈÑÒÈÍÀ;
      X86.PushConst(0);
      ÏÎÊÀ ìÑêàí.ñóùíîñòü # lxRCurly ÄÅËÀÒÜ
         ìÄåöë.Êîîðä_Óñò(line, col);
         ïÂûðàæ(a);
         ìÏðîâ.Òåñò(a.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
         ÅÑËÈ a.eType = eCONST ÒÎÃÄÀ
            ìÏðîâ.Òåñò(ÇÑÏ(ÊÖÅË(a.Value), 5) = 0, line, col, 53)
         ÊÎÍÅÖ;
         Âûðàæ_Çàãðóçèòü(a);
         b := a;
         ÅÑËÈ ìÑêàí.ñóùíîñòü = lxDbl ÒÎÃÄÀ
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            ïÂûðàæ(b);
            ìÏðîâ.Òåñò(b.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            ÅÑËÈ b.eType = eCONST ÒÎÃÄÀ
               ìÏðîâ.Òåñò(ÇÑÏ(ÊÖÅË(b.Value), 5) = 0, line, col, 53);
               ìÏðîâ.Òåñò(a.Value <= b.Value, line, col, 54)
            ÊÎÍÅÖ;
            Âûðàæ_Çàãðóçèòü(b)
         ÈÍÀ×Å
            X86.Dup
         ÊÎÍÅÖ;
         X86.rset;
         X86.Set(ìÊîíñò.îïÏëþñ);
         flag := (a.eType = eCONST) & (b.eType = eCONST) & flag;
         ÅÑËÈ flag ÒÎÃÄÀ
            s := s + {ÊÖÅË(a.Value) .. ÊÖÅË(b.Value)}
         ÊÎÍÅÖ;
         ÅÑËÈ ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÇàïÿòàÿ ÒÎÃÄÀ
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÏðîâ.Òåñò2(ìÑêàí.ñóùíîñòü # lxRCurly, 36)
         ÈÍÀ×Å
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxRCurly)
         ÊÎÍÅÖ
      ÊÎÍÅÖ;
      ÅÑËÈ flag ÒÎÃÄÀ
         e.Value := ÓÄËÈÍ(ÊÂÅÙ(ÍËÈÒ(s)));
         e.eType := eCONST
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
   ÊÎÍÅÖ Set;

ÏÐÎÖÅÄÓÐÀ ÅñëèÑòðîêà(a: ìÄåöë.òÂûðàæåíèå): ÁÓËÅÂÎ;
      ÂÅÐÍÓÒÜ (a.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) ÈËÈ (a.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) & (a.T.Base.òèï_íîì = ìÊîíñò.òèïËÈÒÅÐÀ)
   ÊÎÍÅÖ ÅñëèÑòðîêà;

ÏÐÎÖÅÄÓÐÀ Str(e: ìÄåöë.òÂûðàæåíèå);
   ÏÅÐÅÌ
      A: X86.TIDX;
   ÍÀ×ÀËÎ
      ÅÑËÈ (e.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) & (e.T.Base.òèï_íîì = ìÊîíñò.òèïËÈÒÅÐÀ) & (e.T.äëèíà # 0) ÒÎÃÄÀ
         A[0] := e.T.äëèíà;
         X86.OpenArray(A, 1)
      ÀÅÑËÈ e.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
         A[0] := Ñòð_Äëèíà(e.Value) + 1;
         ÅÑËÈ A[0] # 2 ÒÎÃÄÀ
            X86.OpenArray(A, 1)
         ÊÎÍÅÖ
      ÊÎÍÅÖ
   ÊÎÍÅÖ Str;

ÏÐÎÖÅÄÓÐÀ StFunc(ÏÅÐ e: ìÄåöë.òÂûðàæåíèå; func: ÖÅËÎÅ);
   ÏÅÐÅÌ
      line, col, line2, col2, a, b, p: ÖÅËÎÅ;
      e1, e2: ìÄåöë.òÂûðàæåíèå;
      T: ìÒèï.òóÒèï;
      str, str2: ìÄåöë.òóÊîíñòÑòð;
   ÍÀ×ÀËÎ
      e.vparam := ËÎÆÜ;
      e.eType := eEXP;
      ìÄåöë.Êîîðä_Óñò(line2, col2);
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxLRound);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êîîðä_Óñò(line, col);
      ÂÛÁÎÐ func ÈÇ
         |ìÊîíñò.ïðîöÀÁÑ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ}, line, col, 57);
            Âûðàæ_Çàãðóçèòü(e1);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               e.Value := ABS(e1.Value);
               e.eType := eCONST;
               ìÏðîâ.Òåñò(~((e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ) & (e1.Value = ÓÄËÈÍ(ÊÂÅÙ(ìÊîíñò.öåëîå_ìèí)))), line, col, ìÄåöë.IOVER)
            ÊÎÍÅÖ;
            ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ ÒÎÃÄÀ
               X86.StFunc(ìÊîíñò.ïðîöÀÁÑ)
            ÈÍÀ×Å
               X86.StFunc(ìÊîíñò.ïðîöÀÁÑÂ)
            ÊÎÍÅÖ;
            e.T := e1.T
         |ìÊîíñò.ïðîö×¨Ò:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               e.Value := ÓÄËÈÍ(ÊÂÅÙ(ÍËÈÒ(×¨Ò(ÊÖÅË(e1.Value)))));
               e.eType := eCONST
            ÊÎÍÅÖ;
            X86.StFunc(ìÊîíñò.ïðîö×¨Ò);
            e.T := sttypes[ìÊîíñò.òèïÁÓËÅÂÎ]
         |ìÊîíñò.ïðîöÄËÈÍ:
            Designator(e1);
            ìÏðîâ.Òåñò((e1.eType = eVAR) & (e1.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ), line, col, 102);
            ÅÑËÈ e1.T.äëèíà > 0 ÒÎÃÄÀ
               X86.Len(-e1.T.äëèíà)
            ÈÍÀ×Å
               X86.Len(ìÄåöë.Dim(e1.T))
            ÊÎÍÅÖ;
            e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ]
         |ìÊîíñò.ïðîöËÑË, ìÊîíñò.ïðîöÇÑÏ, ìÊîíñò.ïðîöÖÑÏ, ìÊîíñò.ïðîöËÑÏ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            ïÂûðàæ(e2);
            ìÏðîâ.Òåñò(e2.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e2);
            ÅÑËÈ (e1.eType = eCONST) & (e2.eType = eCONST) ÒÎÃÄÀ
               a := ÊÖÅË(e1.Value);
               b := ÊÖÅË(e2.Value);
               ÂÛÁÎÐ func ÈÇ
                  |ìÊîíñò.ïðîöËÑË: a := ËÑË(a, b)
                  |ìÊîíñò.ïðîöÇÑÏ: a := ÇÑÏ(a, b)
                  |ìÊîíñò.ïðîöÖÑÏ: a := ÖÑÏ(a, b)
                  |ìÊîíñò.ïðîöËÑÏ: a := ËÑÏ(a, b)
               ÈÍÀ×Å
               ÊÎÍÅÖ;
               e.Value := ÓÄËÈÍ(ÊÂÅÙ(a));
               e.eType := eCONST
            ÊÎÍÅÖ;
            ÂÛÁÎÐ func ÈÇ
               |ìÊîíñò.ïðîöËÑË: X86.StFunc(ìÊîíñò.ïðîöËÑË)
               |ìÊîíñò.ïðîöÇÑÏ: X86.StFunc(ìÊîíñò.ïðîöÇÑÏ)
               |ìÊîíñò.ïðîöÖÑÏ: X86.StFunc(ìÊîíñò.ïðîöÖÑÏ)
               |ìÊîíñò.ïðîöËÑÏ: X86.StFunc(ìÊîíñò.ïðîöËÑÏ)
            ÈÍÀ×Å
            ÊÎÍÅÖ;
            e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ]
         |ìÊîíñò.ïðîöÊÖÅË:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ}, line, col, 66);
            Âûðàæ_Çàãðóçèòü(e1);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               ìÏðîâ.Òåñò((e1.Value - 1.0D0 < ÓÄËÈÍ(ÊÂÅÙ(ìÊîíñò.öåëîå_ìàêñ))) & (e1.Value >= ÓÄËÈÍ(ÊÂÅÙ(ìÊîíñò.öåëîå_ìèí))), line, col, 74);
               e.Value := ÓÄËÈÍ(ÊÂÅÙ(ÊÖÅË(e1.Value)));
               e.eType := eCONST
            ÊÎÍÅÖ;
            X86.StFunc(ìÊîíñò.ïðîöÊÖÅË);
            e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ]
         |ìÊîíñò.ïðîöÊÂÅÙ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               e.Value := e1.Value;
               e.eType := eCONST
            ÊÎÍÅÖ;
            X86.StFunc(ìÊîíñò.ïðîöÊÂÅÙ);
            e.T := sttypes[ìÊîíñò.òèïÂÅÙ]
         |ìÊîíñò.ïðîöÍËÈÒ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì Â {ìÊîíñò.òèïËÈÒÅÐÀ, ìÊîíñò.òèïÁÓËÅÂÎ, ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÑÒÐÎÊÀ}, line, col, 68);
            ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
               ìÏðîâ.Òåñò(Ñòð_Äëèíà(e1.Value) = 1, line, col, 94)
            ÊÎÍÅÖ;
            Âûðàæ_Çàãðóçèòü(e1);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
                  str := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e1.Value);
                  e.Value := ÓÄËÈÍ(ÊÂÅÙ(ÍËÈÒ(str.ñòð[0])))
               ÈÍÀ×Å
                  e.Value := e1.Value
               ÊÎÍÅÖ;
               e.eType := eCONST
            ÊÎÍÅÖ;
            ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ ÒÎÃÄÀ
               X86.StFunc(ìÊîíñò.ïðîöÍËÈÒ)
            ÊÎÍÅÖ;
            e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ]
         |ìÊîíñò.ïðîöÁÈÒ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               e.Value := e1.Value;
               e.eType := eCONST
            ÊÎÍÅÖ;
            e.T := sttypes[ìÊîíñò.òèïÍÀÁÎÐ]
         |ìÊîíñò.ïðîöÂËÈÒ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            e.T := sttypes[ìÊîíñò.òèïËÈÒÅÐÀ];
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               ìÏðîâ.Òåñò(ÇÑÏ(ÊÖÅË(e1.Value), 8) = 0, line, col, 76);
               str2 := ìÄåöë.ÑòðÌîíî_Ñîçäàòü(ÂËÈÒ(ÊÖÅË(e1.Value)));
               mSys.GET(mSys.ADR(str2), p);
               e.Value := ÓÄËÈÍ(ÊÂÅÙ(p));
               e.T := sttypes[ìÊîíñò.òèïÑÒÐÎÊÀ];
               e.eType := eCONST
            ÊÎÍÅÖ
         |ìÊîíñò.ïðîöÓÄËÈÍ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÂÅÙ, line, col, 71);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               e.Value := e1.Value;
               e.eType := eCONST
            ÊÎÍÅÖ;
            Âûðàæ_Çàãðóçèòü(e1);
            e.T := sttypes[ìÊîíñò.òèïÄËÈÍÂÅÙ]
         |ìÊîíñò.ïðîöÓÊÎÐÎÒ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÄËÈÍÂÅÙ, line, col, 70);
            ÅÑËÈ e1.eType = eCONST ÒÎÃÄÀ
               ìÏðîâ.Òåñò(ABS(e1.Value) <= ÓÄËÈÍ(ìÊîíñò.âåù_ìàêñ), line, col, ìÄåöë.FOVER);
               ìÏðîâ.Òåñò(ABS(e1.Value) >= ÓÄËÈÍ(ìÊîíñò.âåù_ìèí), line, col, ìÄåöë.UNDER);
               e.Value := e1.Value;
               e.eType := eCONST
            ÊÎÍÅÖ;
            Âûðàæ_Çàãðóçèòü(e1);
            e.T := sttypes[ìÊîíñò.òèïÂÅÙ]
         |ìÊîíñò.ïðîöÄËÈÍÑÒÐ:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(ÅñëèÑòðîêà(e1), line, col, 141);
            ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
               str := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e1.Value);
               ÅÑËÈ str.äëèíà = 1 ÒÎÃÄÀ
                  X86.Mono(str.íîìåð);
                  X86.StrMono
               ÊÎÍÅÖ;
               e.Value := ÓÄËÈÍ(ÊÂÅÙ(ÄËÈÍÑÒÐ(str.ñòð)));
               e.eType := eCONST
            ÊÎÍÅÖ;
            Str(e1);
            e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ];
            X86.StFunc(ìÊîíñò.ïðîöÄËÈÍÑÒÐ)
         |ìÊîíñò.sysADR:
            ìÏðîâ.Òåñò((ìÑêàí.ñóùíîñòü = lxIDENT) ÈËÈ (ìÑêàí.ñóùíîñòü = lxSTRING) ÈËÈ (ìÑêàí.ñóùíîñòü = lxCHX), line, col, 43);
            ÅÑËÈ ìÑêàí.ñóùíîñòü = lxIDENT ÒÎÃÄÀ
               Designator(e1);
               ìÏðîâ.Òåñò((e1.eType = eVAR) ÈËÈ (e1.eType = ePROC) ÈËÈ (e1.T = sttypes[ìÊîíñò.òèïÑÒÐÎÊÀ]), line, col, 43);
               ÅÑËÈ e1.eType = ePROC ÒÎÃÄÀ
                  X86.PushInt(e1.id.Number)
               ÊÎÍÅÖ
            ÈÍÀ×Å
               pFactor(e1)
            ÊÎÍÅÖ;
            ÅÑËÈ e1.T = sttypes[ìÊîíñò.òèïÑÒÐÎÊÀ] ÒÎÃÄÀ
               str := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e1.Value);
               ÅÑËÈ str.äëèíà = 1 ÒÎÃÄÀ
                  X86.Drop;
                  X86.PushInt(str.íîìåð)
               ÊÎÍÅÖ
            ÊÎÍÅÖ;
            e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ];
            X86.ADR(ìÄåöë.Dim(e1.T))
         |ìÊîíñò.sysBIT:
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            ïÂûðàæ(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            X86.StFunc(ìÊîíñò.sysBIT);
            e.T := sttypes[ìÊîíñò.òèïÁÓËÅÂÎ]
         |ìÊîíñò.sysSIZE, ìÊîíñò.sysTYPEID:
            ìÄåöë.ÏðîöåäóðÐàçì_Óñò;
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxIDENT);
            T := ìÄåöë.IdType(line, col);
            ìÏðîâ.Òåñò(T # ÏÓÑÒÎ, line, col, 42);
            e.eType := eCONST;
            e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ];
            ÅÑËÈ func = ìÊîíñò.sysTYPEID ÒÎÃÄÀ
               ìÏðîâ.Òåñò(T.òèï_íîì Â {ìÊîíñò.òèïÇÀÏÈÑÜ, ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ}, line, col, 47);
               ÅÑËÈ T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ ÒÎÃÄÀ
                  T := T.Base
               ÊÎÍÅÖ;
               e.Value := ÓÄËÈÍ(ÊÂÅÙ(T.íîìåð));
               X86.PushConst(T.íîìåð)
            ÈÍÀ×Å
               e.Value := ÓÄËÈÍ(ÊÂÅÙ(T.ðàçìåð));
               X86.PushConst(T.ðàçìåð)
            ÊÎÍÅÖ
      ÈÍÀ×Å
         ìÏðîâ.Òåñò(ËÎÆÜ, line2, col2, 73)
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÑêîáêàÏðÊð);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
   ÊÎÍÅÖ StFunc;

ÏÐÎÖÅÄÓÐÀ ProcTypeComp(T1, T2: ìÒèï.òóÒèï): ÁÓËÅÂÎ;
   ÏÅÐÅÌ
      sp: ÖÅËÎÅ;
      stk: ÌÀÑÑÈÂ 100, 2 ÈÇ ìÒèï.òóÒèï;

   ÏÐÎÖÅÄÓÐÀ ProcTypeComp1(T1, T2: ìÒèï.òóÒèï): ÁÓËÅÂÎ;
      ÏÅÐÅÌ
         fp, ft: ìÄåöë.òóÏîëå;
         Res: ÁÓËÅÂÎ;

      ÏÐÎÖÅÄÓÐÀ TypeComp(T1, T2: ìÒèï.òóÒèï): ÁÓËÅÂÎ;
         ÏÅÐÅÌ
            Res: ÁÓËÅÂÎ;
         ÍÀ×ÀËÎ
            ÅÑËÈ (T1.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) & (T2.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) & (T1.äëèíà = 0) & (T2.äëèíà = 0) ÒÎÃÄÀ
               Res := TypeComp(T1.Base, T2.Base)
            ÈÍÀ×Å
              Res := ProcTypeComp1(T1, T2)
            ÊÎÍÅÖ
            ÂÅÐÍÓÒÜ Res
         ÊÎÍÅÖ TypeComp;

      ÏÐÎÖÅÄÓÐÀ Check(): ÁÓËÅÂÎ;
         ÏÅÐÅÌ
            i: ÖÅËÎÅ;
            res: ÁÓËÅÂÎ;
         ÍÀ×ÀËÎ
            i := 0;
            res := ËÎÆÜ;
            ÏÎÊÀ (i < sp) & ~res ÄÅËÀÒÜ
               res := ((stk[i][0] = T1) & (stk[i][1] = T2)) ÈËÈ ((stk[i][0] = T2) & (stk[i][1] = T1));
               ÄÎÁ(i)
            ÊÎÍÅÖ
            ÂÅÐÍÓÒÜ res
         ÊÎÍÅÖ Check;

        ÍÀ×ÀËÎ
          ÄÎÁ(sp);
          stk[sp][0] := T1;
          stk[sp][1] := T2;
          ÅÑËÈ Check() ÒÎÃÄÀ
            Res := ÈÑÒÈÍÀ
          ÈÍÀ×Å
            ÅÑËÈ (T1.òèï_íîì = ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ) & (T2.òèï_íîì = ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ) & (T1 # T2) ÒÎÃÄÀ
              Res := (T1.âûçîâ = T2.âûçîâ) & (T1.ïîëÿ.ñ÷åò÷èê = T2.ïîëÿ.ñ÷åò÷èê) & ProcTypeComp1(T1.Base, T2.Base);
              fp := T1.ïîëÿ.ïðåäûäóù(ìÄåöë.òóÏîëå);
              ft := T2.ïîëÿ.ïðåäûäóù(ìÄåöë.òóÏîëå);
              ÏÎÊÀ Res & (fp # ÏÓÑÒÎ) ÄÅËÀÒÜ
                Res := (fp.ByRef = ft.ByRef) & TypeComp(fp.T, ft.T);
                fp := fp.ñëåäóþù(ìÄåöë.òóÏîëå);
                ft := ft.ñëåäóþù(ìÄåöë.òóÏîëå)
              ÊÎÍÅÖ
            ÈÍÀ×Å
              Res := T1 = T2
            ÊÎÍÅÖ
          ÊÎÍÅÖ;
          ÂÛ×(sp)
          ÂÅÐÍÓÒÜ Res
        ÊÎÍÅÖ ProcTypeComp1;

   ÍÀ×ÀËÎ
      sp := -1
      ÂÅÐÍÓÒÜ ProcTypeComp1(T1, T2)
   ÊÎÍÅÖ ProcTypeComp;

ÏÐÎÖÅÄÓÐÀ ArrComp(Ta, Tf: ìÒèï.òóÒèï): ÁÓËÅÂÎ;
   ÏÅÐÅÌ
      Res: ÁÓËÅÂÎ;
   ÍÀ×ÀËÎ
      ÅÑËÈ (Tf.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) & (Tf.äëèíà = 0) & (Ta.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) ÒÎÃÄÀ
        Res := ArrComp(Ta.Base, Tf.Base)
      ÈÍÀ×Å
        Res := ProcTypeComp(Ta, Tf)
      ÊÎÍÅÖ
      ÂÅÐÍÓÒÜ Res
   ÊÎÍÅÖ ArrComp;

ÏÐÎÖÅÄÓÐÀ AssComp(e: ìÄåöë.òÂûðàæåíèå; T: ìÒèï.òóÒèï; param: ÁÓËÅÂÎ): ÁÓËÅÂÎ;
   ÏÅÐÅÌ
      Res: ÁÓËÅÂÎ;
   ÍÀ×ÀËÎ
      ÂÛÁÎÐ T.òèï_íîì ÈÇ
         |ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ, ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÁÓËÅÂÎ, ìÊîíñò.TCARD16:
            Res := e.T = T
         |ìÊîíñò.òèïËÈÒÅÐÀ:
            ÅÑËÈ e.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
               Res := Ñòð_Äëèíà(e.Value) = 1
            ÈÍÀ×Å
               Res := e.T.òèï_íîì = ìÊîíñò.òèïËÈÒÅÐÀ
            ÊÎÍÅÖ
         |ìÊîíñò.òèïÌÀÑÑÈÂ:
            ÅÑËÈ param ÒÎÃÄÀ
               ÅÑËÈ T.äëèíà = 0 ÒÎÃÄÀ
                  ÅÑËÈ (T.Base.òèï_íîì = ìÊîíñò.òèïËÈÒÅÐÀ) & (e.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) ÒÎÃÄÀ
                     Res := ÈÑÒÈÍÀ
                  ÈÍÀ×Å
                     Res := ArrComp(e.T, T)
                  ÊÎÍÅÖ
               ÈÍÀ×Å
                  ÅÑËÈ (T.Base.òèï_íîì = ìÊîíñò.òèïËÈÒÅÐÀ) & (e.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) ÒÎÃÄÀ
                     Res := Ñòð_Äëèíà(e.Value) <= T.äëèíà
                  ÈÍÀ×Å
                     Res := e.T = T
                  ÊÎÍÅÖ
               ÊÎÍÅÖ
               ÈÍÀ×Å
               ÅÑËÈ T.äëèíà = 0 ÒÎÃÄÀ
                  Res := ËÎÆÜ
               ÀÅÑËÈ (T.Base.òèï_íîì = ìÊîíñò.òèïËÈÒÅÐÀ) & (e.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) ÒÎÃÄÀ
                  Res := Ñòð_Äëèíà(e.Value) <= T.äëèíà
               ÈÍÀ×Å
                  Res := e.T = T
               ÊÎÍÅÖ
            ÊÎÍÅÖ
         |ìÊîíñò.òèïÇÀÏÈÑÜ: Res := BaseOf(T, e.T)
         |ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ: Res := BaseOf(T, e.T) ÈËÈ (e.T.òèï_íîì = ìÊîíñò.òèïÏÓÑÒÎ)
         |ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ: Res := (e.T.òèï_íîì = ìÊîíñò.òèïÏÓÑÒÎ) ÈËÈ (e.eType = ePROC) & ProcTypeComp(e.id.T, T) ÈËÈ
            (e.eType # ePROC) & ProcTypeComp(e.T, T)
      ÈÍÀ×Å
         Res := ËÎÆÜ
      ÊÎÍÅÖ
      ÂÅÐÍÓÒÜ Res
   ÊÎÍÅÖ AssComp;

ÏÐÎÖÅÄÓÐÀ ParamComp(e: ìÄåöë.òÂûðàæåíèå; T: ìÒèï.òóÒèï; ByRef: ÁÓËÅÂÎ): ÁÓËÅÂÎ;
   ÏÅÐÅÌ
      Res: ÁÓËÅÂÎ;
   ÍÀ×ÀËÎ
      ÅÑËÈ ByRef ÒÎÃÄÀ
         ÅÑËÈ e.eType = eVAR ÒÎÃÄÀ
            ÂÛÁÎÐ T.òèï_íîì ÈÇ
               |ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ, ìÊîíñò.òèïËÈÒÅÐÀ,
                  ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÁÓËÅÂÎ, ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, ìÊîíñò.TCARD16:
                  Res := e.T = T
               |ìÊîíñò.òèïÌÀÑÑÈÂ:
                  ÅÑËÈ T.äëèíà > 0 ÒÎÃÄÀ
                      Res := e.T = T
                  ÈÍÀ×Å
                      Res := ArrComp(e.T, T)
                  ÊÎÍÅÖ
               |ìÊîíñò.òèïÇÀÏÈÑÜ:
                  Res := BaseOf(T, e.T)
               |ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ:
                  Res := ProcTypeComp(e.T, T)
            ÈÍÀ×Å
            ÊÎÍÅÖ
         ÈÍÀ×Å
            Res := ËÎÆÜ
         ÊÎÍÅÖ
      ÈÍÀ×Å
         Res := AssComp(e, T, ÈÑÒÈÍÀ)
      ÊÎÍÅÖ
      ÂÅÐÍÓÒÜ Res
    ÊÎÍÅÖ ParamComp;

ÏÐÎÖÅÄÓÐÀ Call(param: ìÄåöë.òóÏîëå);
   ÏÅÐÅÌ
      line, col, i, n: ÖÅËÎÅ;
      e1: ìÄåöë.òÂûðàæåíèå;
      s: ìÄåöë.òóÊîíñòÑòð;
      A: X86.TIDX;
      TA: ìÒèï.òóÒèï;
   ÍÀ×ÀËÎ
      ÏÎÊÀ param # ÏÓÑÒÎ ÄÅËÀÒÜ
         ìÄåöë.Êîîðä_Óñò(line, col);
         X86.Param;
         ïÂûðàæ(e1);
         ìÏðîâ.Òåñò(ParamComp(e1, param.T, param.ByRef), line, col, 114);
         ìÏðîâ.Òåñò(~(param.ByRef & e1.Read), line, col, 115);
         ìÏðîâ.Òåñò(~((e1.eType = ePROC) & (e1.id.Level > 3)), line, col, 116);
         ÅÑËÈ (e1.eType = eVAR) & ~param.ByRef ÒÎÃÄÀ
            X86.Load(e1.T.òèï_íîì)
         ÊÎÍÅÖ;
         ÅÑËÈ param.ByRef & (e1.T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ) ÒÎÃÄÀ
            ÅÑËÈ e1.vparam ÒÎÃÄÀ
               X86.LocalAdr(e1.id.Offset - 4, ìÄåöë.ìîäóëü.óðîâåíü - e1.id.Level);
               X86.Load(ìÊîíñò.òèïÖÅËÎÅ)
            ÀÅÑËÈ e1.deref ÒÎÃÄÀ
               X86.DerefType(0)
            ÈÍÀ×Å
               X86.PushConst(e1.T.íîìåð)
            ÊÎÍÅÖ
         ÊÎÍÅÖ;
         ÅÑËÈ ~param.ByRef & (param.T.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ}) ÒÎÃÄÀ
            X86.DropFpu(param.T.òèï_íîì = ìÊîíñò.òèïÄËÈÍÂÅÙ)
         ÊÎÍÅÖ;
         ÅÑËÈ (e1.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) & (param.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) ÒÎÃÄÀ
            s := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e1.Value);
            ÅÑËÈ s.äëèíà = 1 ÒÎÃÄÀ
               X86.Mono(s.íîìåð)
            ÊÎÍÅÖ;
            ÅÑËÈ param.T.äëèíà = 0 ÒÎÃÄÀ
               A[0] := s.äëèíà + 1;
               X86.OpenArray(A, 1)
            ÊÎÍÅÖ
         ÊÎÍÅÖ;
         ÅÑËÈ (e1.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) & (ìÄåöë.Dim(param.T) > ìÄåöë.Dim(e1.T)) ÒÎÃÄÀ
            n := ìÄåöë.Dim(param.T) - ìÄåöë.Dim(e1.T);
            TA := ìÄåöë.OpenBase(e1.T);
            ÄËß i := 0 ÄÎ n - 1 ÄÅËÀÒÜ
               A[i] := TA.äëèíà;
               TA := TA.Base
            ÊÎÍÅÖ;
            ÅÑËÈ ìÄåöë.Dim(e1.T) = 0 ÒÎÃÄÀ
               X86.OpenArray(A, n)
            ÈÍÀ×Å
               X86.ExtArray(A, n, ìÄåöë.Dim(e1.T))
            ÊÎÍÅÖ
         ÊÎÍÅÖ;
         param := param.ñëåäóþù(ìÄåöë.òóÏîëå);
         ÅÑËÈ param # ÏÓÑÒÎ ÒÎÃÄÀ
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
         ÊÎÍÅÖ
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÑêîáêàÏðÊð);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
   ÊÎÍÅÖ Call;

ÏÐÎÖÅÄÓÐÀ Factor(ÏÅÐ e: ìÄåöë.òÂûðàæåíèå);
   ÏÅÐÅÌ
      line, col, ccall, p: ÖÅËÎÅ;
      begcall: X86.òóÇâåíîÀñì;
      s, str2: ìÄåöë.òóÊîíñòÑòð;
   ÍÀ×ÀËÎ
      e.eType := eCONST;
      e.vparam := ËÎÆÜ;
      ÂÛÁÎÐ ìÑêàí.ñóùíîñòü ÈÇ
      |lxIDENT:
         begcall := X86.current;
         Designator(e);
         ÅÑËÈ e.eType = ePROC ÒÎÃÄÀ
            ÅÑËÈ ìÑêàí.ñóùíîñòü = lxLRound ÒÎÃÄÀ
               ìÏðîâ.Òåñò2(e.id.T.Base.òèï_íîì # ìÊîíñò.TVOID, 73);
               ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
               X86.PushCall(begcall);
               Call(e.id.T.ïîëÿ.ïðåäûäóù(ìÄåöë.òóÏîëå));
               X86.Âûçîâ_Çàêîí÷èòü;
               e.eType := eEXP;
               e.T := e.id.T.Base;
               ÅÑËÈ e.id.Level = 3 ÒÎÃÄÀ
                  ccall := 0
               ÀÅÑËÈ e.id.Level > ìÄåöë.curBlock.Level ÒÎÃÄÀ
                  ccall := 1
               ÈÍÀ×Å
                  ccall := 2
               ÊÎÍÅÖ;
               X86.Call(e.id.Number, ÈÑÒÈÍÀ, e.T.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ}, e.id.T.âûçîâ, ccall, e.id.Level - 3,
               ìÄåöë.curBlock.Level - 3, e.id.ParamSize, ìÄåöë.curBlock.LocalSize)
            ÈÍÀ×Å
               X86.PushInt(e.id.Number)
            ÊÎÍÅÖ
         ÀÅÑËÈ (e.eType = eVAR) & (e.T.òèï_íîì = ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ) & (ìÑêàí.ñóùíîñòü = lxLRound) ÒÎÃÄÀ
            ìÏðîâ.Òåñò2(e.T.Base.òèï_íîì # ìÊîíñò.TVOID, 73);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            X86.PushCall(begcall);
            Call(e.T.ïîëÿ.ïðåäûäóù(ìÄåöë.òóÏîëå));
            X86.Âûçîâ_Çàêîí÷èòü;
            e.eType := eEXP;
            X86.CallVar(ÈÑÒÈÍÀ, e.T.Base.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ}, e.T.âûçîâ, e.T.äëèíà, ìÄåöë.curBlock.LocalSize);
            e.T := e.T.Base;
         ÀÅÑËÈ e.eType Â {eSTPROC, eSYSPROC} ÒÎÃÄÀ
            StFunc(e, e.id.StProc)
         ÊÎÍÅÖ
      |ìÊîíñò.êñÏÓÑÒÎ:
         e.T := sttypes[ìÊîíñò.òèïÏÓÑÒÎ];
         e.Value := 0.0D0;
         X86.PushConst(0);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |ìÊîíñò.êñÈÑÒÈÍÀ:
         e.T := sttypes[ìÊîíñò.òèïÁÓËÅÂÎ];
         e.Value := 1.0D0;
         X86.PushConst(1);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |ìÊîíñò.êñËÎÆÜ:
         e.T := sttypes[ìÊîíñò.òèïÁÓËÅÂÎ];
         e.Value := 0.0D0;
         X86.PushConst(0);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |lxCHX, lxSTRING:
         ÅÑËÈ ìÑêàí.ñóùíîñòü = lxSTRING ÒÎÃÄÀ
            ìÑêàí.GetLexStr(ñòðÑóùí);
            str2 := ìÄåöë.Ñòð_Ñîçäàòü(ñòðÑóùí);
            mSys.GET(mSys.ADR(str2), p);
            e.Value := ÓÄËÈÍ(ÊÂÅÙ(p));
            s := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e.Value);
            ÅÑËÈ s.äëèíà = 1 ÒÎÃÄÀ
               X86.PushConst(ÍËÈÒ(s.ñòð[0]))
            ÈÍÀ×Å
               X86.PushInt(s.íîìåð)
            ÊÎÍÅÖ
         ÈÍÀ×Å
            str2 := ìÄåöë.ÑòðÌîíî_Ñîçäàòü(ìÑêàí.vCHX);
            mSys.GET(mSys.ADR(str2), p);
            e.Value := ÓÄËÈÍ(ÊÂÅÙ(p));
            X86.PushConst(ÍËÈÒ(ìÑêàí.vCHX))
         ÊÎÍÅÖ;
         e.T := sttypes[ìÊîíñò.òèïÑÒÐÎÊÀ];
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |lxREAL:
         e.T := sttypes[ìÊîíñò.òèïÂÅÙ];
         e.Value := ìÑêàí.vFLT;
         X86.PushFlt(ìÑêàí.vFLT);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |lxLONGREAL:
         e.T := sttypes[ìÊîíñò.òèïÄËÈÍÂÅÙ];
         e.Value := ìÑêàí.vFLT;
         X86.PushFlt(ìÑêàí.vFLT);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |lxINT, lxHEX:
         e.T := sttypes[ìÊîíñò.òèïÖÅËÎÅ];
         e.Value := ÓÄËÈÍ(ÊÂÅÙ(ìÑêàí.vINT));
         X86.PushConst(ìÑêàí.vINT);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |lxLRound:
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ïÂûðàæ(e);
         ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÑêîáêàÏðÊð);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      |ìÊîíñò.îïÎòðèö:
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ìÄåöë.Êîîðä_Óñò(line, col);
         Factor(e);
         ìÏðîâ.Òåñò(e.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ, line, col, 37);
         Âûðàæ_Çàãðóçèòü(e);
         ÅÑËÈ e.eType = eCONST ÒÎÃÄÀ
            e.Value := ÓÄËÈÍ(ÊÂÅÙ(ÍËÈÒ(e.Value = 0.0D0)))
         ÈÍÀ×Å
            e.eType := eEXP
         ÊÎÍÅÖ;
         X86.Not;
         e.vparam := ËÎÆÜ
      |ìÊîíñò.îïÑêîáêàËåâÔèã:
         Set(e)
      ÈÍÀ×Å
         ìÏðîâ.Òåñò2(ËÎÆÜ, 36)
      ÊÎÍÅÖ
   ÊÎÍÅÖ Factor;

ÏÐÎÖÅÄÓÐÀ IsChr(a: ìÄåöë.òÂûðàæåíèå): ÁÓËÅÂÎ;
      ÂÅÐÍÓÒÜ (a.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) & (Ñòð_Äëèíà(a.Value) = 1) ÈËÈ (a.T.òèï_íîì = ìÊîíñò.òèïËÈÒÅÐÀ)
   ÊÎÍÅÖ IsChr;

ÏÐÎÖÅÄÓÐÀ StrRel(a, b: ìÄåöë.òÂûðàæåíèå; Op: ÖÅËÎÅ);
   ÍÀ×ÀËÎ
      ÅÑËÈ ~(IsChr(a) ÈËÈ IsChr(b)) ÒÎÃÄÀ
         X86.strcmp(Op, 0)
      ÀÅÑËÈ IsChr(a) & IsChr(b) ÒÎÃÄÀ
         X86.CmpInt(Op)
      ÀÅÑËÈ IsChr(a) ÒÎÃÄÀ
         X86.strcmp(Op, 1)
      ÈÍÀ×Å
         X86.strcmp(Op, -1)
      ÊÎÍÅÖ
   ÊÎÍÅÖ StrRel;

ÏÐÎÖÅÄÓÐÀ log2(n: ÖÅËÎÅ): ÖÅËÎÅ;
   ÏÅÐÅÌ
      x, i: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      x := 1;
      i := 0;
      ÏÎÊÀ (x # n) & (i < 31) ÄÅËÀÒÜ
         x := ËÑË(x, 1);
         ÄÎÁ(i)
      ÊÎÍÅÖ;
      ÅÑËÈ x # n ÒÎÃÄÀ
         i := -1
      ÊÎÍÅÖ
      ÂÅÐÍÓÒÜ i
   ÊÎÍÅÖ log2;

ÏÐÎÖÅÄÓÐÀ Operation(ÏÅÐ a, b: ìÄåöë.òÂûðàæåíèå; Op, line, col: ÖÅËÎÅ);
   ÏÅÐÅÌ
      n, m: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      ÂÛÁÎÐ Op ÈÇ
      |ìÊîíñò.îïÏëþñ, ìÊîíñò.îïÌèíóñ, ìÊîíñò.îïÓìíîæ, ìÊîíñò.îïÄåëåí:
         ìÏðîâ.Òåñò((a.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ, ìÊîíñò.òèïÍÀÁÎÐ}) & (a.T.òèï_íîì = b.T.òèï_íîì), line, col, 37);
         ìÏðîâ.Òåñò(~((Op = ìÊîíñò.îïÄåëåí) & (a.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ)), line, col, 37);
         ÂÛÁÎÐ a.T.òèï_íîì ÈÇ
            |ìÊîíñò.òèïÖÅËÎÅ: X86.Int(Op)
            |ìÊîíñò.òèïÍÀÁÎÐ: X86.Set(Op)
            |ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ: X86.farith(Op)
         ÈÍÀ×Å
         ÊÎÍÅÖ
      |lxDIV, lxMOD:
         ìÏðîâ.Òåñò((a.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ) & (b.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ), line, col, 37);
         ÅÑËÈ b.eType = eCONST ÒÎÃÄÀ
         m := ÊÖÅË(b.Value);
         ìÏðîâ.Òåñò(m # 0, line, col, 48);
         n := log2(m);
         ÅÑËÈ n = -1 ÒÎÃÄÀ
            X86.idivmod(Op = lxMOD)
         ÈÍÀ×Å
            X86.Drop;
            ÅÑËÈ Op = lxMOD ÒÎÃÄÀ
               n := ÍËÈÒ(-ÁÈÒ(ËÑË(-1, n)));
               X86.PushConst(n);
               X86.Set(ìÊîíñò.îïÓìíîæ)
            ÈÍÀ×Å
               X86.PushConst(n);
               X86.StFunc(ìÊîíñò.ïðîöÇÑÏ)
            ÊÎÍÅÖ
         ÊÎÍÅÖ
      ÈÍÀ×Å
         X86.idivmod(Op = lxMOD)
      ÊÎÍÅÖ
      |ìÊîíñò.îïÈ, ìÊîíñò.lxOR:
         ìÏðîâ.Òåñò((a.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ) & (b.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ), line, col, 37)
      |ìÊîíñò.êñÂ:
          ìÏðîâ.Òåñò((a.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ) & (b.T.òèï_íîì = ìÊîíñò.òèïÍÀÁÎÐ), line, col, 37);
          X86.inset
      |ìÊîíñò.îïÌåíüøå, lxLE, ìÊîíñò.îïÁîëüøå, lxGE:
         ìÏðîâ.Òåñò(((a.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ}) & (a.T.òèï_íîì = b.T.òèï_íîì)) ÈËÈ
         (IsChr(a) ÈËÈ ÅñëèÑòðîêà(a)) & (IsChr(b) ÈËÈ ÅñëèÑòðîêà(b)) ÈËÈ
         (a.T.òèï_íîì = ìÊîíñò.òèïÍÀÁÎÐ) & (b.T.òèï_íîì = ìÊîíñò.òèïÍÀÁÎÐ) & ((Op = lxLE) ÈËÈ (Op = lxGE)), line, col, 37);
         ÅÑËÈ a.T.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ} ÒÎÃÄÀ
            X86.fcmp(Op)
         ÀÅÑËÈ a.T.òèï_íîì = ìÊîíñò.òèïÍÀÁÎÐ ÒÎÃÄÀ
            X86.Inclusion(Op)
         ÀÅÑËÈ ÅñëèÑòðîêà(a) ÈËÈ ÅñëèÑòðîêà(b) ÒÎÃÄÀ
            StrRel(a, b, Op)
         ÈÍÀ×Å
            X86.CmpInt(Op)
         ÊÎÍÅÖ
      |ìÊîíñò.îïÐàâíî, ìÊîíñò.îïÍåÐàâíî:
         ìÏðîâ.Òåñò(((a.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ, ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÁÓËÅÂÎ}) & (a.T.òèï_íîì = b.T.òèï_íîì)) ÈËÈ
         (IsChr(a) ÈËÈ ÅñëèÑòðîêà(a)) & (IsChr(b) ÈËÈ ÅñëèÑòðîêà(b)) ÈËÈ
         (a.T.òèï_íîì Â {ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ, ìÊîíñò.òèïÏÓÑÒÎ}) & (b.T.òèï_íîì = ìÊîíñò.òèïÏÓÑÒÎ) ÈËÈ
         (b.T.òèï_íîì Â {ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ, ìÊîíñò.òèïÏÓÑÒÎ}) & (a.T.òèï_íîì = ìÊîíñò.òèïÏÓÑÒÎ) ÈËÈ
         (a.T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ) & (b.T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ) & (BaseOf(a.T, b.T) ÈËÈ BaseOf(b.T, a.T)) ÈËÈ
         (a.T.òèï_íîì = ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ) & ProcTypeComp(b.T, a.T) ÈËÈ (a.eType = ePROC) & ProcTypeComp(b.T, a.id.T) ÈËÈ
         (b.eType = ePROC) & ProcTypeComp(a.T, b.id.T), line, col, 37);
         ÅÑËÈ a.T.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ} ÒÎÃÄÀ
            X86.fcmp(Op)
         ÀÅÑËÈ ÅñëèÑòðîêà(a) ÈËÈ ÅñëèÑòðîêà(b) ÒÎÃÄÀ
            StrRel(a, b, Op)
         ÈÍÀ×Å
            X86.CmpInt(Op)
         ÊÎÍÅÖ
      ÈÍÀ×Å
      ÊÎÍÅÖ;
      ÅÑËÈ (a.eType # eCONST) ÈËÈ (b.eType # eCONST) ÒÎÃÄÀ
         a.eType := eEXP;
         ÅÑËÈ ìÄåöë.Relation(Op) ÒÎÃÄÀ
            a.T := sttypes[ìÊîíñò.òèïÁÓËÅÂÎ]
         ÊÎÍÅÖ
      ÈÍÀ×Å
         ìÄåöë.Calc(a.Value, b.Value, a.T, b.T, Op, line, col, a.Value, a.T)
      ÊÎÍÅÖ;
      a.vparam := ËÎÆÜ
   ÊÎÍÅÖ Operation;

ÏÐÎÖÅÄÓÐÀ Term(ÏÅÐ e: ìÄåöë.òÂûðàæåíèå);
   ÏÅÐÅÌ
      a: ìÄåöë.òÂûðàæåíèå;
      Op, line, col, L: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      Factor(e);
      ÏÎÊÀ (ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÓìíîæ) ÈËÈ (ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÄåëåí) ÈËÈ
         (ìÑêàí.ñóùíîñòü = lxDIV) ÈËÈ (ìÑêàí.ñóùíîñòü = lxMOD) ÈËÈ
         (ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÈ) ÄÅËÀÒÜ
         Âûðàæ_Çàãðóçèòü(e);
         ìÄåöë.Êîîðä_Óñò(line, col);
         Op := ìÑêàí.ñóùíîñòü;
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ÅÑËÈ Op = ìÊîíñò.îïÈ ÒÎÃÄÀ
            L := X86.NewLabel();
            X86.IfWhile(L, ËÎÆÜ)
         ÊÎÍÅÖ;
         Factor(a);
         Âûðàæ_Çàãðóçèòü(a);
         ÅÑËÈ Op = ìÊîíñò.îïÈ ÒÎÃÄÀ
            X86.Label(L)
         ÊÎÍÅÖ;
         Operation(e, a, Op, line, col)
      ÊÎÍÅÖ
   ÊÎÍÅÖ Term;

ÏÐÎÖÅÄÓÐÀ Simple(ÏÅÐ e: ìÄåöë.òÂûðàæåíèå);
   ÏÅÐÅÌ
      a: ìÄåöë.òÂûðàæåíèå;
      Op, line, col, uOp, uline, ucol, L: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      uOp := 0;
      ÅÑËÈ (ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÏëþñ) ÈËÈ (ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÌèíóñ) ÒÎÃÄÀ
         ìÄåöë.Êîîðä_Óñò(uline, ucol);
         uOp := ìÑêàí.ñóùíîñòü;
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
      ÊÎÍÅÖ;
      Term(e);
      ÅÑËÈ uOp # 0 ÒÎÃÄÀ
         ìÏðîâ.Òåñò(e.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ, ìÊîíñò.òèïÍÀÁÎÐ}, uline, ucol, 37);
         Âûðàæ_Çàãðóçèòü(e);
         ÅÑËÈ uOp = ìÊîíñò.îïÌèíóñ ÒÎÃÄÀ
            ÂÛÁÎÐ e.T.òèï_íîì ÈÇ
               |ìÊîíñò.òèïÖÅËÎÅ: X86.NegInt
               |ìÊîíñò.òèïÍÀÁÎÐ: X86.NegSet
               |ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ: X86.fneg
            ÈÍÀ×Å
            ÊÎÍÅÖ
         ÊÎÍÅÖ;
         ÅÑËÈ (uOp = ìÊîíñò.îïÌèíóñ) & (e.eType = eCONST) ÒÎÃÄÀ
            ÂÛÁÎÐ e.T.òèï_íîì ÈÇ
               |ìÊîíñò.òèïÖÅËÎÅ:
                  ìÏðîâ.Òåñò(e.Value # ÓÄËÈÍ(ÊÂÅÙ(ìÊîíñò.öåëîå_ìèí)), uline, ucol, ìÄåöë.IOVER)
               |ìÊîíñò.òèïÍÀÁÎÐ:
                  e.Value := -ÓÄËÈÍ(ÊÂÅÙ(ÍËÈÒ(-ÁÈÒ(ÊÖÅË(e.Value)))))
            ÈÍÀ×Å
            ÊÎÍÅÖ;
            e.Value := -e.Value
         ÊÎÍÅÖ;
         ÅÑËÈ e.eType # eCONST ÒÎÃÄÀ
            e.eType := eEXP
         ÊÎÍÅÖ;
         e.vparam := ËÎÆÜ
      ÊÎÍÅÖ;
      ÏÎÊÀ (ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÏëþñ) ÈËÈ (ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÌèíóñ) ÈËÈ (ìÑêàí.ñóùíîñòü = ìÊîíñò.lxOR) ÄÅËÀÒÜ
         Âûðàæ_Çàãðóçèòü(e);
         ìÄåöë.Êîîðä_Óñò(line, col);
         Op := ìÑêàí.ñóùíîñòü;
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ÅÑËÈ Op = ìÊîíñò.lxOR ÒÎÃÄÀ
            L := X86.NewLabel();
            X86.IfWhile(L, ÈÑÒÈÍÀ)
         ÊÎÍÅÖ;
         Term(a);
         Âûðàæ_Çàãðóçèòü(a);
         ÅÑËÈ Op = ìÊîíñò.lxOR ÒÎÃÄÀ
            X86.Label(L)
         ÊÎÍÅÖ;
         Operation(e, a, Op, line, col)
      ÊÎÍÅÖ
   ÊÎÍÅÖ Simple;

ÏÐÎÖÅÄÓÐÀ Expr(ÏÅÐ e: ìÄåöë.òÂûðàæåíèå);
   ÏÅÐÅÌ
      a: ìÄåöë.òÂûðàæåíèå;
      Op, line, col, line2, col2, fpu: ÖÅËÎÅ;
      T: ìÒèï.òóÒèï;
      beg: X86.òóÇâåíîÀñì;
      s: ìÄåöë.òóÊîíñòÑòð;
   ÍÀ×ÀËÎ
      fpu := X86.fpu;
      beg := X86.current;
      Simple(e);
      ÅÑËÈ ìÄåöë.Relation(ìÑêàí.ñóùíîñòü) ÒÎÃÄÀ
         ìÄåöë.Êîîðä_Óñò(line, col);
         Op := ìÑêàí.ñóùíîñòü;
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ÅÑËÈ Op = ìÊîíñò.êñÅÑÒÜ ÒÎÃÄÀ
            ìÏðîâ.Òåñò(e.T.òèï_íîì Â {ìÊîíñò.òèïÇÀÏÈÑÜ, ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ}, line, col, 37);
            ÅÑËÈ e.T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ ÒÎÃÄÀ
               ìÏðîâ.Òåñò(e.vparam, line, col, 37)
            ÊÎÍÅÖ;
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxIDENT);
            ìÄåöë.Êîîðä_Óñò(line2, col2);
            T := ìÄåöë.IdType(line2, col2);
            ìÏðîâ.Òåñò(T # ÏÓÑÒÎ, line2, col2, 42);
            ÅÑËÈ e.T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ ÒÎÃÄÀ
               ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ, line2, col2, 106)
            ÈÍÀ×Å
               ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, line2, col2, 107)
            ÊÎÍÅÖ;
            ìÏðîâ.Òåñò(BaseOf(e.T, T), line, col, 37);
            ÅÑËÈ e.T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ ÒÎÃÄÀ
               X86.Drop;
               X86.LocalAdr(e.id.Offset, ìÄåöë.ìîäóëü.óðîâåíü - e.id.Level)
            ÊÎÍÅÖ;
            Âûðàæ_Çàãðóçèòü(e);
            ÅÑËÈ e.T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ ÒÎÃÄÀ
               T := T.Base
            ÊÎÍÅÖ;
            X86.Guard(T.íîìåð, ÈÑÒÈÍÀ);
            e.T := sttypes[ìÊîíñò.òèïÁÓËÅÂÎ];
            e.eType := eEXP;
            e.vparam := ËÎÆÜ
         ÈÍÀ×Å
            Âûðàæ_Çàãðóçèòü(e);
            Str(e);
            Simple(a);
            Âûðàæ_Çàãðóçèòü(a);
            Str(a);
            Operation(e, a, Op, line, col)
         ÊÎÍÅÖ
      ÊÎÍÅÖ;
      ÅÑËÈ e.eType = eCONST ÒÎÃÄÀ
         X86.Del(beg);
         X86.Setfpu(fpu);
         ÅÑËÈ ~ìÄåöë.Const ÒÎÃÄÀ
            ÂÛÁÎÐ e.T.òèï_íîì ÈÇ
               |ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ:
                  X86.PushFlt(e.Value)
               |ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÁÓËÅÂÎ, ìÊîíñò.òèïÏÓÑÒÎ:
                  X86.PushConst(ÊÖÅË(e.Value))
               |ìÊîíñò.òèïÑÒÐÎÊÀ:
                  s := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e.Value);
                  ÅÑËÈ s.äëèíà = 1 ÒÎÃÄÀ
                    X86.PushConst(ÍËÈÒ(s.ñòð[0]))
                  ÈÍÀ×Å
                    X86.PushInt(s.íîìåð)
                  ÊÎÍÅÖ
            ÈÍÀ×Å
            ÊÎÍÅÖ
         ÊÎÍÅÖ
      ÊÎÍÅÖ
   ÊÎÍÅÖ Expr;

ÏÐÎÖÅÄÓÐÀ IfWhileOper(wh: ÁÓËÅÂÎ);
   ÏÅÐÅÌ
      e: ìÄåöë.òÂûðàæåíèå;
      line, col, L, L3: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      L := X86.NewLabel();
      ÅÑËÈ wh ÒÎÃÄÀ
        X86.Label(L)
      ÊÎÍÅÖ;
      ÏÎÂÒÎÐßÒÜ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ìÄåöë.Êîîðä_Óñò(line, col);
         Expr(e);
         ìÏðîâ.Òåñò(e.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ, line, col, 117);
         Âûðàæ_Çàãðóçèòü(e);
         ÅÑËÈ wh ÒÎÃÄÀ
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÄÅËÀÒÜ)
         ÈÍÀ×Å
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÒÎÃÄÀ)
         ÊÎÍÅÖ;
         L3 := X86.NewLabel();
         X86.ifwh(L3);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         pOpSeq;
         X86.jmp(X86.JMP, L);
         X86.Label(L3)
      ÏÎÊÀÍÅ ìÑêàí.ñóùíîñòü # ìÊîíñò.êñÀÅÑËÈ;
      ÅÑËÈ ~wh & (ìÑêàí.ñóùíîñòü = ìÊîíñò.êñÈÍÀ×Å) ÒÎÃÄÀ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         pOpSeq
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÊÎÍÅÖ);
      ÅÑËÈ ~wh ÒÎÃÄÀ
         X86.Label(L)
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
   ÊÎÍÅÖ IfWhileOper;

ÏÐÎÖÅÄÓÐÀ ÊëÑëîâî_ÏÎÂÒÎÐ;
   ÏÅÐÅÌ
      e: ìÄåöë.òÂûðàæåíèå;
      line, col, L: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      L := X86.NewLabel();
      X86.Label(L);
      pOpSeq;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÏÎÊÀÍÅ);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êîîðä_Óñò(line, col);
      Expr(e);
      ìÏðîâ.Òåñò(e.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ, line, col, 117);
      Âûðàæ_Çàãðóçèòü(e);
      X86.ifwh(L)
   ÊÎÍÅÖ ÊëÑëîâî_ÏÎÂÒÎÐ;

ÏÐÎÖÅÄÓÐÀ ÊëÑëîâî_ÄËß;
   ÏÅÐÅÌ
      e: ìÄåöë.òÂûðàæåíèå;
      line, col, LBeg, LEnd, iValue: ÖÅËÎÅ;
      Value: ÄËÈÍÂÅÙ;
      T: ìÒèï.òóÒèï;
      name: ìÓçåë.òóÓçåë;
      id: ìÄåöë.òóÑóùíîñòü;
   ÍÀ×ÀËÎ
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxIDENT);
      name := ìÑêàí.id;
      id := ìÄåöë.GetIdent(name);
      ìÏðîâ.Òåñò2(id # ÏÓÑÒÎ, 42);
      ìÏðîâ.Òåñò2(id.iType = IDVAR, 126);
      ìÏðîâ.Òåñò2(id.VarKind = 0, 127);
      ìÏðîâ.Òåñò2(id.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, 128);
      ìÏðîâ.Òåñò2(id.Level = ìÄåöë.ìîäóëü.óðîâåíü, 129);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxAssign);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êîîðä_Óñò(line, col);
      ÅÑËÈ id.Level = 3 ÒÎÃÄÀ
         X86.GlobalAdr(id.Offset)
      ÈÍÀ×Å
         X86.LocalAdr(id.Offset, 0)
      ÊÎÍÅÖ;
      X86.Dup;
      Expr(e);
      ìÏðîâ.Òåñò(e.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
      Âûðàæ_Çàãðóçèòü(e);
      X86.Save(ìÊîíñò.òèïÖÅËÎÅ);
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÄÎ);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êîîðä_Óñò(line, col);
      Expr(e);
      ìÏðîâ.Òåñò(e.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
      Âûðàæ_Çàãðóçèòü(e);
      iValue := 1;
      ÅÑËÈ ìÑêàí.ñóùíîñòü = lxBY ÒÎÃÄÀ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ìÄåöë.Êîîðä_Óñò(line, col);
         ìÄåöë.ConstExpr(Value, T);
         ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
         iValue := ÊÖÅË(Value);
         ìÏðîâ.Òåñò(iValue # 0, line, col, 122)
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÄÅËÀÒÜ);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      X86.For(iValue > 0, LBeg, LEnd);
      pOpSeq;
      X86.NextFor(iValue, LBeg, LEnd);
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÊÎÍÅÖ);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
   ÊÎÍÅÖ ÊëÑëîâî_ÄËß;

ÏÐÎÖÅÄÓÐÀ Ìåòêà_Ïðîâåðèòü(a, b: ÖÅËÎÅ; Labels: ìÖåïü.òóÖåïü): ÁÓËÅÂÎ;
   ÏÅÐÅÌ 
      cur: òÌåòêà;
   ÍÀ×ÀËÎ
      cur := Labels.ïðåäûäóù(òÌåòêà);
      ÏÎÊÀ (cur # ÏÓÑÒÎ) & ((b < cur.a) ÈËÈ (a > cur.b)) ÄÅËÀÒÜ
        cur := cur.ñëåäóþù(òÌåòêà)
      ÊÎÍÅÖ
      ÂÅÐÍÓÒÜ cur = ÏÓÑÒÎ
   ÊÎÍÅÖ Ìåòêà_Ïðîâåðèòü;

ÏÐÎÖÅÄÓÐÀ LabelVal(ÏÅÐ a: ÖÅËÎÅ; int: ÁÓËÅÂÎ);
   ÏÅÐÅÌ
      Value: ÄËÈÍÂÅÙ;
      T: ìÒèï.òóÒèï;
      s: ìÄåöë.òóÊîíñòÑòð;
      line, col: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      ìÄåöë.Êîîðä_Óñò(line, col);
      ìÄåöë.ConstExpr(Value, T);
      ÅÑËÈ int ÒÎÃÄÀ
         ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 161);
         a := ÊÖÅË(Value)
      ÈÍÀ×Å
         ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ, line, col, 55);
         s := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(Value);
         ìÏðîâ.Òåñò(s.äëèíà = 1, line, col, 94);
         a := ÍËÈÒ(s.ñòð[0])
      ÊÎÍÅÖ
   ÊÎÍÅÖ LabelVal;

ÏÐÎÖÅÄÓÐÀ Label(int: ÁÓËÅÂÎ; Labels: ìÖåïü.òóÖåïü; LBeg: ÖÅËÎÅ);
   ÏÅÐÅÌ
      a, b: ÖÅËÎÅ;
      label: òÌåòêà;
      line, col: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      ìÄåöë.Êîîðä_Óñò(line, col);
      LabelVal(a, int);
      b := a;
      ÅÑËÈ ìÑêàí.ñóùíîñòü = lxDbl ÒÎÃÄÀ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         LabelVal(b, int)
      ÊÎÍÅÖ;
      ìÏðîâ.Òåñò(a <= b, line, col, 54);
      ìÏðîâ.Òåñò(Ìåòêà_Ïðîâåðèòü(a, b, Labels), line, col, 100);
      ÍÎÂ(label);
      ìÏàì.Ìàëî(label = ÏÓÑÒÎ);
      label.a := a;
      label.b := b;
      ìÖåïü.Äîáàâèòü(Labels, label);
      X86.CaseLabel(a, b, LBeg)
   ÊÎÍÅÖ Label;

ÏÐÎÖÅÄÓÐÀ Variant(int: ÁÓËÅÂÎ; Labels: ìÖåïü.òóÖåïü; EndCase: ÖÅËÎÅ);
   ÏÅÐÅÌ
      LBeg, LEnd: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      LBeg := X86.NewLabel();
      LEnd := X86.NewLabel();
      ÅÑËÈ ~((ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÂûáîð) ÈËÈ (ìÑêàí.ñóùíîñòü = ìÊîíñò.êñÊÎÍÅÖ)) ÒÎÃÄÀ
         Label(int, Labels, LBeg);
         ÏÎÊÀ ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÇàïÿòàÿ ÄÅËÀÒÜ
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            Label(int, Labels, LBeg)
         ÊÎÍÅÖ;
         ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÄâîåòî÷);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         X86.jmp(X86.JMP, LEnd);
         X86.Label(LBeg);
         pOpSeq;
         X86.jmp(X86.JMP, EndCase);
         X86.Label(LEnd)
      ÊÎÍÅÖ
   ÊÎÍÅÖ Variant;

ÏÐÎÖÅÄÓÐÀ ÊëÑëîâî_ÂÛÁÎÐ;
   ÏÅÐÅÌ
      e: ìÄåöë.òÂûðàæåíèå;
      int: ÁÓËÅÂÎ;
      line, col, EndCase: ÖÅËÎÅ;
      Labels: ìÖåïü.òóÖåïü;
   ÍÀ×ÀËÎ
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êîîðä_Óñò(line, col);
      Expr(e);
      ìÏðîâ.Òåñò(e.T.òèï_íîì Â {ìÊîíñò.òèïËÈÒÅÐÀ, ìÊîíñò.òèïÑÒÐÎÊÀ, ìÊîíñò.òèïÖÅËÎÅ}, line, col, 156);
      ìÏðîâ.Òåñò(~((e.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) & (Ñòð_Äëèíà(e.Value) # 1)), line, col, 94);
      int := e.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÈÇ);
      Âûðàæ_Çàãðóçèòü(e);
      X86.Drop;
      Labels := ìÖåïü.Ñîçäàòü();
      ìÏàì.Ìàëî(Labels = ÏÓÑÒÎ);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      EndCase := X86.NewLabel();
      Variant(int, Labels, EndCase);
      ÏÎÊÀ ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÂûáîð ÄÅËÀÒÜ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         Variant(int, Labels, EndCase)
      ÊÎÍÅÖ;
      ÅÑËÈ ìÑêàí.ñóùíîñòü = ìÊîíñò.êñÈÍÀ×Å ÒÎÃÄÀ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         pOpSeq
      ÈÍÀ×Å
         ìÓòèëü.ÊîäÑòðîêà_Óñò(ìÄåöë.UnitNumber, ìÑêàí.öÑòðîêà);
         X86.OnError(7)
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.êñÊÎÍÅÖ);
      X86.Label(EndCase);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÖåïü.Î÷èñòèòü(Labels)
   ÊÎÍÅÖ ÊëÑëîâî_ÂÛÁÎÐ;

ÏÐÎÖÅÄÓÐÀ CheckCode(Code: ìÑòð.òÑòðîêà; Len, line, col: ÖÅËÎÅ);
   ÏÅÐÅÌ
      i: ÖÅËÎÅ;
   ÍÀ×ÀËÎ
      ìÏðîâ.Òåñò(~ODD(Len), line, col, 34);
      ÄËß i := 0 ÄÎ Len - 1 ÄÅËÀÒÜ
         ìÏðîâ.Òåñò(ìÑêàí.×èñëî16_Ïîëó÷(Code[i]), line, col, 34)
      ÊÎÍÅÖ
   ÊÎÍÅÖ CheckCode;

ÏÐÎÖÅÄÓÐÀ StProc(proc: ÖÅËÎÅ);
   ÏÅÐÅÌ
      line, col, line2, col2, iValue: ÖÅËÎÅ;
      e1, e2: ìÄåöë.òÂûðàæåíèå;
      Value: ÄËÈÍÂÅÙ;
      T: ìÒèï.òóÒèï;
      str: ìÄåöë.òóÊîíñòÑòð;
      begcall: X86.òóÇâåíîÀñì;
   ÍÀ×ÀËÎ
      ìÄåöë.Êîîðä_Óñò(line2, col2);
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxLRound);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ìÄåöë.Êîîðä_Óñò(line, col);
      ÂÛÁÎÐ proc ÈÇ
         |ìÊîíñò.ïðîöÄÎÁ, ìÊîíñò.ïðîöÂÛ×:
            Designator(e1);
            ìÏðîâ.Òåñò(e1.eType = eVAR, line, col, 63);
            ìÏðîâ.Òåñò(~e1.Read, line, col, 115);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 128);
            ÅÑËÈ ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÇàïÿòàÿ ÒÎÃÄÀ
               ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
               ìÄåöë.Êîîðä_Óñò(line, col);
               ìÄåöë.ConstExpr(Value, T);
               ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
               iValue := ÊÖÅË(Value);
               ìÏðîâ.Òåñò(iValue # 0, line, col, 122);
               ÅÑËÈ iValue < 0 ÒÎÃÄÀ
                  ÅÑËÈ proc = ìÊîíñò.ïðîöÄÎÁ ÒÎÃÄÀ
                     proc := ìÊîíñò.ïðîöÂÛ×
                  ÈÍÀ×Å
                     proc := ìÊîíñò.ïðîöÄÎÁ
                  ÊÎÍÅÖ;
                  iValue := -iValue
               ÊÎÍÅÖ;
               ÅÑËÈ iValue # 1 ÒÎÃÄÀ
                  X86.PushConst(iValue);
                  ÅÑËÈ proc = ìÊîíñò.ïðîöÂÛ× ÒÎÃÄÀ
                     X86.StProc(ìÊîíñò.ïðîöÂÛ×)
                  ÈÍÀ×Å
                     X86.StProc(ìÊîíñò.ïðîöÄÎÁ)
                  ÊÎÍÅÖ
               ÈÍÀ×Å
                  ÅÑËÈ proc = ìÊîíñò.ïðîöÂÛ× ÒÎÃÄÀ
                     X86.StProc(ìÊîíñò.ïðîöÇÍÑËÎÆ)
                  ÈÍÀ×Å
                     X86.StProc(ìÊîíñò.ïðîöÄÎÏÎËÍ)
                  ÊÎÍÅÖ
               ÊÎÍÅÖ
            ÈÍÀ×Å
               ÅÑËÈ proc = ìÊîíñò.ïðîöÂÛ× ÒÎÃÄÀ
                  X86.StProc(ìÊîíñò.ïðîöÇÍÑËÎÆ)
               ÈÍÀ×Å
                  X86.StProc(ìÊîíñò.ïðîöÄÎÏÎËÍ)
               ÊÎÍÅÖ
            ÊÎÍÅÖ
         |ìÊîíñò.ïðîöÄÎÁÂ, ìÊîíñò.ïðîöÂÛ×Â:
            Designator(e1);
            ìÏðîâ.Òåñò(e1.eType = eVAR, line, col, 63);
            ìÏðîâ.Òåñò(~e1.Read, line, col, 115);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÍÀÁÎÐ, line, col, 138);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            ìÄåöë.ConstExpr(Value, T);
            ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            iValue := ÊÖÅË(Value);
            ìÏðîâ.Òåñò(ÇÑÏ(iValue, 5) = 0, line, col, 53);
            ÅÑËÈ proc = ìÊîíñò.ïðîöÄÎÁÂ ÒÎÃÄÀ
               X86.PushConst(ÍËÈÒ({iValue}));
               X86.StProc(ìÊîíñò.ïðîöÄÎÁÂ)
            ÈÍÀ×Å
               X86.PushConst(ÍËÈÒ(-{iValue}));
               X86.StProc(ìÊîíñò.ïðîöÂÛ×Â)
            ÊÎÍÅÖ
         |ìÊîíñò.ïðîöÊÎÏÈß:
            Expr(e1);
            ìÏðîâ.Òåñò(ÅñëèÑòðîêà(e1), line, col, 141);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
               str := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e1.Value);
               ÅÑËÈ str.äëèíà = 1 ÒÎÃÄÀ
                  X86.Mono(str.íîìåð);
                  X86.StrMono
               ÊÎÍÅÖ
            ÊÎÍÅÖ;
            Str(e1);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            Designator(e2);
            ìÏðîâ.Òåñò(e2.eType = eVAR, line, col, 63);
            ìÏðîâ.Òåñò(ÅñëèÑòðîêà(e2), line, col, 143);
            ìÏðîâ.Òåñò(~e2.Read, line, col, 115);
            Str(e2);
            X86.StProc(ìÊîíñò.ïðîöÊÎÏÈß)
         |ìÊîíñò.ïðîöÍÎÂ, ìÊîíñò.ïðîöËÈØÍ:
            Designator(e1);
            ìÏðîâ.Òåñò(e1.eType = eVAR, line, col, 63);
            ìÏðîâ.Òåñò(~e1.Read, line, col, 115);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÓÊÀÇÀÒÅËÜ, line, col, 145);
            ÅÑËÈ proc = ìÊîíñò.ïðîöÍÎÂ ÒÎÃÄÀ
               X86.PushConst(e1.T.Base.íîìåð);
               X86.PushConst(X86.Align(e1.T.Base.ðàçìåð + 8, 32));
               X86.newrec
            ÈÍÀ×Å
               X86.disprec
            ÊÎÍÅÖ
         |ìÊîíñò.ïðîöÊÎÍÒÐÎËÜ:
            Expr(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ, line, col, 117);
            Âûðàæ_Çàãðóçèòü(e1);
            ÅÑËÈ ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÇàïÿòàÿ ÒÎÃÄÀ
               ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
               ìÄåöë.Êîîðä_Óñò(line, col);
               ìÄåöë.ConstExpr(Value, T);
               ìÏðîâ.Òåñò(T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
               ìÏðîâ.Òåñò((Value >= 0.0D0) & (Value <= 127.0D0), line, col, 95);
               X86.Assert(ìÊîíñò.ïðîöÊÎÍÒÐÎËÜ, ÊÖÅË(Value))
            ÈÍÀ×Å
               X86.Assert(ìÊîíñò.ïðîöÊÎÍÒÐÏÈ, 0)
            ÊÎÍÅÖ
         |ìÊîíñò.ïðîöÓÏÀÊ, ìÊîíñò.ïðîöÐÀÑÏ:
            Designator(e1);
            ìÏðîâ.Òåñò(e1.eType = eVAR, line, col, 63);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì Â {ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ}, line, col, 149);
            ìÏðîâ.Òåñò(~e1.Read, line, col, 115);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            ÅÑËÈ proc = ìÊîíñò.ïðîöÐÀÑÏ ÒÎÃÄÀ
               Designator(e2);
               ìÏðîâ.Òåñò(e2.eType = eVAR, line, col, 63);
               ìÏðîâ.Òåñò(e2.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 128);
               ìÏðîâ.Òåñò(~e2.Read, line, col, 115);
               ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÄËÈÍÂÅÙ ÒÎÃÄÀ
                  X86.StProc(ìÊîíñò.ïðîöÐÀÑÏ)
               ÈÍÀ×Å
                  X86.StProc(ìÊîíñò.ïðîöÐÀÑÏÑÏÅÖ)
               ÊÎÍÅÖ
            ÈÍÀ×Å
               Expr(e2);
               ìÏðîâ.Òåñò(e2.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
               Âûðàæ_Çàãðóçèòü(e2);
               ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÄËÈÍÂÅÙ ÒÎÃÄÀ
                  X86.StProc(ìÊîíñò.ïðîöÓÏÀÊ)
               ÈÍÀ×Å
                  X86.StProc(ìÊîíñò.ïðîöÓÏÀÊÑÏÅÖ)
               ÊÎÍÅÖ
            ÊÎÍÅÖ
         |ìÊîíñò.sysBIT:
            Expr(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            Expr(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1)
         |ìÊîíñò.sysPUT, ìÊîíñò.sysGET:
            begcall := X86.current;
            Expr(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            ÅÑËÈ proc = ìÊîíñò.sysGET ÒÎÃÄÀ
               X86.PushCall(begcall);
               X86.Param;
               Designator(e2);
               ìÏðîâ.Òåñò(e2.eType = eVAR, line, col, 63);
               ìÏðîâ.Òåñò(e2.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ, ìÊîíñò.òèïËÈÒÅÐÀ, ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÁÓËÅÂÎ, ìÊîíñò.TCARD16}, line, col, 154);
               ìÏðîâ.Òåñò(~e2.Read, line, col, 115);
               X86.Âûçîâ_Çàêîí÷èòü;
               X86.Load(e2.T.òèï_íîì);
               X86.Save(e2.T.òèï_íîì)
            ÈÍÀ×Å
               Expr(e2);
               ìÏðîâ.Òåñò(e2.T.òèï_íîì Â {ìÊîíñò.òèïÖÅËÎÅ, ìÊîíñò.òèïÂÅÙ, ìÊîíñò.òèïÄËÈÍÂÅÙ, ìÊîíñò.òèïËÈÒÅÐÀ, ìÊîíñò.òèïÍÀÁÎÐ, ìÊîíñò.òèïÁÓËÅÂÎ, ìÊîíñò.TCARD16, ìÊîíñò.òèïÑÒÐÎÊÀ}, line, col, 153);
               ÅÑËÈ e2.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ ÒÎÃÄÀ
                  ìÏðîâ.Òåñò(Ñòð_Äëèíà(e2.Value) = 1, line, col, 94)
               ÊÎÍÅÖ;
               Âûðàæ_Çàãðóçèòü(e2);
               X86.Save(e2.T.òèï_íîì)
            ÊÎÍÅÖ
         |ìÊîíñò.sysCODE:
            ìÏðîâ.Òåñò(ìÑêàí.ñóùíîñòü = lxSTRING, line, col, 150);
            ìÑêàí.GetLexStr(ñòðÑóùí);
            CheckCode(ñòðÑóùí, ìÑêàí.ñ÷¸ò÷èê - 1, line, col);
            X86.Asm(ñòðÑóùí);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
         |ìÊîíñò.sysMOVE:
            begcall := X86.current;
            Expr(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            X86.PushCall(begcall);
            X86.Param;
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            Expr(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÇàïÿòàÿ);
            X86.Âûçîâ_Çàêîí÷èòü;
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            Expr(e1);
            ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÖÅËÎÅ, line, col, 52);
            Âûðàæ_Çàãðóçèòü(e1);
      ÈÍÀ×Å
         ìÏðîâ.Òåñò(ËÎÆÜ, line2, col2, 132)
      ÊÎÍÅÖ;
      ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÑêîáêàÏðÊð);
      ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
      ÅÑËÈ proc = ìÊîíñò.sysMOVE ÒÎÃÄÀ
         X86.StProc(ìÊîíñò.sysMOVE);
      ÀÅÑËÈ proc = ìÊîíñò.sysBIT ÒÎÃÄÀ
         ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxAssign);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ìÄåöë.Êîîðä_Óñò(line, col);
         Expr(e1);
         ìÏðîâ.Òåñò(e1.T.òèï_íîì = ìÊîíñò.òèïÁÓËÅÂÎ, line, col, 117);
         Âûðàæ_Çàãðóçèòü(e1);
         X86.StProc(ìÊîíñò.sysBIT)
      ÊÎÍÅÖ
   ÊÎÍÅÖ StProc;

ÏÐÎÖÅÄÓÐÀ IdentOper;
   ÏÅÐÅÌ
      e1, e2: ìÄåöë.òÂûðàæåíèå;
      line, col, ccall: ÖÅËÎÅ;
      begcall: X86.òóÇâåíîÀñì;
      s: ìÄåöë.òóÊîíñòÑòð;
   ÍÀ×ÀËÎ
      ìÄåöë.Êîîðä_Óñò(line, col);
      begcall := X86.current;
      Designator(e1);
      ìÏðîâ.Òåñò(e1.eType # eCONST, line, col, 130);
      ÅÑËÈ (e1.eType = eVAR) & (e1.T.òèï_íîì # ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ) ÒÎÃÄÀ
         ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxAssign);
         ìÏðîâ.Òåñò(~e1.Read, line, col, 115);
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ìÄåöë.Êîîðä_Óñò(line, col);
         Expr(e2);
         ìÏðîâ.Òåñò(AssComp(e2, e1.T, ËÎÆÜ), line, col, 131);
         Âûðàæ_Çàãðóçèòü(e2);
         ÅÑËÈ e1.T.òèï_íîì = ìÊîíñò.òèïÇÀÏÈÑÜ ÒÎÃÄÀ
            X86.PushConst(e1.T.ðàçìåð);
            X86.PushConst(e1.T.íîìåð);
            ÅÑËÈ e1.vparam ÒÎÃÄÀ
               X86.LocalAdr(e1.id.Offset - 4, ìÄåöë.ìîäóëü.óðîâåíü - e1.id.Level);
               X86.Load(ìÊîíñò.òèïÖÅËÎÅ)
            ÀÅÑËÈ e1.deref ÒÎÃÄÀ
               X86.DerefType(12)
            ÈÍÀ×Å
               X86.PushConst(e1.T.íîìåð)
            ÊÎÍÅÖ
         ÀÅÑËÈ e2.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ ÒÎÃÄÀ
            X86.PushConst(e2.T.ðàçìåð)
         ÀÅÑËÈ (e2.T.òèï_íîì = ìÊîíñò.òèïÑÒÐÎÊÀ) & (e1.T.òèï_íîì = ìÊîíñò.òèïÌÀÑÑÈÂ) ÒÎÃÄÀ
            s := ìÄåöë.óÊîíñòÑòð_Ïîëó÷(e2.Value);
            ÅÑËÈ s.äëèíà = 1 ÒÎÃÄÀ
               X86.Mono(s.íîìåð)
            ÊÎÍÅÖ;
            X86.PushConst(ìÓòèëü.Ìèíèìóì(s.äëèíà + 1, e1.T.äëèíà))
         ÊÎÍÅÖ;
         X86.Save(e1.T.òèï_íîì)
      ÀÅÑËÈ e1.eType = ePROC ÒÎÃÄÀ
         ìÏðîâ.Òåñò((e1.id.T.Base.òèï_íîì = ìÊîíñò.TVOID) ÈËÈ (e1.id.T.âûçîâ = ìÄåöë.winapi), line, col, 132);
         ÅÑËÈ e1.id.ParamCount > 0 ÒÎÃÄÀ
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(lxLRound);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            X86.PushCall(begcall);
            Call(e1.id.T.ïîëÿ.ïðåäûäóù(ìÄåöë.òóÏîëå));
            X86.Âûçîâ_Çàêîí÷èòü
         ÀÅÑËÈ ìÑêàí.ñóùíîñòü = lxLRound ÒÎÃÄÀ
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êëþ÷_Ïðîâåðèòü(ìÊîíñò.îïÑêîáêàÏðÊð);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷
         ÊÎÍÅÖ;
         ÅÑËÈ e1.id.Level = 3 ÒÎÃÄÀ
            ccall := 0
         ÀÅÑËÈ e1.id.Level > ìÄåöë.curBlock.Level ÒÎÃÄÀ
            ccall := 1
         ÈÍÀ×Å
            ccall := 2
         ÊÎÍÅÖ;
         X86.Call(e1.id.Number, ËÎÆÜ, ËÎÆÜ, e1.id.T.âûçîâ, ccall, e1.id.Level - 3, ìÄåöë.curBlock.Level - 3, e1.id.ParamSize, ìÄåöë.curBlock.LocalSize)
      ÀÅÑËÈ e1.eType Â {eSTPROC, eSYSPROC} ÒÎÃÄÀ
          StProc(e1.id.StProc)
      ÀÅÑËÈ (e1.eType = eVAR) & (e1.T.òèï_íîì = ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ) ÒÎÃÄÀ
         ÅÑËÈ ìÑêàí.ñóùíîñòü = lxLRound ÒÎÃÄÀ
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÏðîâ.Òåñò((e1.T.Base.òèï_íîì = ìÊîíñò.TVOID) ÈËÈ (e1.T.âûçîâ = ìÄåöë.winapi), line, col, 132);
            X86.PushCall(begcall);
            Call(e1.T.ïîëÿ.ïðåäûäóù(ìÄåöë.òóÏîëå));
            X86.Âûçîâ_Çàêîí÷èòü;
            X86.CallVar(ËÎÆÜ, ËÎÆÜ, e1.T.âûçîâ, e1.T.äëèíà, ìÄåöë.curBlock.LocalSize)
         ÀÅÑËÈ ìÑêàí.ñóùíîñòü = lxAssign ÒÎÃÄÀ
            ìÏðîâ.Òåñò(~e1.Read, line, col, 115);
            ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
            ìÄåöë.Êîîðä_Óñò(line, col);
            Expr(e2);
            ìÏðîâ.Òåñò(AssComp(e2, e1.T, ËÎÆÜ), line, col, 131);
            ìÏðîâ.Òåñò(~((e2.eType = ePROC) & (e2.id.Level > 3)), line, col, 116);
            ÅÑËÈ e2.eType = eVAR ÒÎÃÄÀ
               X86.Load(ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ)
            ÊÎÍÅÖ;
            X86.Save(ìÊîíñò.òèïÏÐÎÖÅÄÓÐÀ)
         ÈÍÀ×Å
            ìÏðîâ.Òåñò2(e1.T.ïîëÿ.ñ÷åò÷èê = 0, 155);
            ìÏðîâ.Òåñò((e1.T.Base.òèï_íîì = ìÊîíñò.TVOID) ÈËÈ (e1.T.âûçîâ = ìÄåöë.winapi), line, col, 132);
            X86.CallVar(ËÎÆÜ, ËÎÆÜ, e1.T.âûçîâ, e1.T.äëèíà, ìÄåöë.curBlock.LocalSize)
         ÊÎÍÅÖ
      ÊÎÍÅÖ
   ÊÎÍÅÖ IdentOper;

ÏÐÎÖÅÄÓÐÀ ÊëÑëîâî_Âûáðàòü;
   ÍÀ×ÀËÎ
      ìÓòèëü.ÊîäÑòðîêà_Óñò(ìÄåöë.UnitNumber, ìÑêàí.öÑòðîêà);
      ÂÛÁÎÐ ìÑêàí.ñóùíîñòü ÈÇ
         |lxIDENT: IdentOper
         |ìÊîíñò.êñÅÑËÈ, ìÊîíñò.êñÏÎÊÀ: IfWhileOper(ìÑêàí.ñóùíîñòü = ìÊîíñò.êñÏÎÊÀ)
         |ìÊîíñò.êñÏÎÂÒÎÐ: ÊëÑëîâî_ÏÎÂÒÎÐ
         |ìÊîíñò.êñÄËß: ÊëÑëîâî_ÄËß
         |ìÊîíñò.êñÂÛÁÎÐ: ÊëÑëîâî_ÂÛÁÎÐ
      ÈÍÀ×Å
      ÊÎÍÅÖ
   ÊÎÍÅÖ ÊëÑëîâî_Âûáðàòü;

ÏÐÎÖÅÄÓÐÀ OpSeq;
   ÍÀ×ÀËÎ
      ÊëÑëîâî_Âûáðàòü;
      ÏÎÊÀ ìÑêàí.ñóùíîñòü = ìÊîíñò.îïÒ÷êÇïò ÄÅËÀÒÜ
         ìÄåöë.Êëþ÷Ñëåä_Ïîëó÷;
         ÊëÑëîâî_Âûáðàòü
      ÊÎÍÅÖ
   ÊÎÍÅÖ OpSeq;

ÏÐÎÖÅÄÓÐÀ Ñòàðò;
   ÏÅÐÅÌ
      ñàì_èìÿ, ñàì_ïóòü, CName, CExt, ïóòü, StdPath,
      temp, felf: ìÑòð.òÑòðîêà;
      ñòåê: ìÑòåê.òÑòåê;
      ÎÑ: ìÎÑ.òÎÑ;
      óÔàéë: ìÔàéë.òóÔàéë;

   ÏÐÎÖÅÄÓÐÀ getver(): ÖÅËÎÅ;
      ÏÅÐÅÌ
         res, i: ÖÅËÎÅ;
         áÎøèáêà: ÁÓËÅÂÎ;

      ÏÐÎÖÅÄÓÐÀ Ñèìâ_Hex(c: ËÈÒ): ÁÓËÅÂÎ;
            ÂÅÐÍÓÒÜ ("0" <= c) & (c <= "9") ÈËÈ
                  ("A" <= c) & (c <= "F") ÈËÈ
                  ("a" <= c) & (c <= "f")
         ÊÎÍÅÖ Ñèìâ_Hex;

      ÏÐÎÖÅÄÓÐÀ ÑèìâÍåõ_â_Öåëîå(c: ËÈÒ): ÖÅËÎÅ;
         ÏÅÐÅÌ
            ÷èñëî: ÖÅËÎÅ;
         ÍÀ×ÀËÎ
            ÅÑËÈ  ("0" <= c) & (c <= "9") ÒÎÃÄÀ
               ÷èñëî := ÍËÈÒ(c) - ÍËÈÒ("0")
            ÀÅÑËÈ ("A" <= c) & (c <= "F") ÒÎÃÄÀ
               ÷èñëî := ÍËÈÒ(c) - ÍËÈÒ("A") + 10
            ÀÅÑËÈ ("a" <= c) & (c <= "f") ÒÎÃÄÀ
               ÷èñëî := ÍËÈÒ(c) - ÍËÈÒ("a") + 10
            ÊÎÍÅÖ
               ÂÅÐÍÓÒÜ ÷èñëî
         ÊÎÍÅÖ ÑèìâÍåõ_â_Öåëîå;

      ÍÀ×ÀËÎ
         res := 0;
         i := 0;
         áÎøèáêà := ñòåê.ñòðÐàçìåð[i] # "0";
         ÄÎÁ(i);
         áÎøèáêà := áÎøèáêà ÈËÈ (ñòåê.ñòðÐàçìåð[i] # "x");
         ÄÎÁ(i);
         
         ÏÎÊÀ ~áÎøèáêà & Ñèìâ_Hex(ñòåê.ñòðÐàçìåð[i]) ÄÅËÀÒÜ
            ÄÎÁ(i)
         ÊÎÍÅÖ;
               
         áÎøèáêà := áÎøèáêà ÈËÈ (i = 2);
         
         ÅÑËÈ ñòåê.ñòðÐàçìåð[i] <= 20X ÒÎÃÄÀ
            ñòåê.ñòðÐàçìåð[i] := 0X
         ÈÍÀ×Å
            áÎøèáêà := ÈÑÒÈÍÀ
         ÊÎÍÅÖ;
         i := 2;
         ÏÎÊÀ ~áÎøèáêà & (ñòåê.ñòðÐàçìåð[i] # 0X) ÄÅËÀÒÜ
            res := ËÑË(res, 4) + ÑèìâÍåõ_â_Öåëîå(ñòåê.ñòðÐàçìåð[i]);
            ÄÎÁ(i)
         ÊÎÍÅÖ;
         ÅÑËÈ res = 0 ÒÎÃÄÀ
               res := 1
         ÊÎÍÅÖ
         ÂÅÐÍÓÒÜ res
      ÊÎÍÅÖ getver;

   ÍÀ×ÀËÎ
      ÍÎÂ(óÔàéë);
      ÅÑËÈ ìÓòèëü.ïàðàìåòðû_âñåãî < 2 ÒÎÃÄÀ
         ìÎø.Ñîîáù(ìÎøÊîíñò.îøÌàëîÏàðàì);
         ìÏðîö.Çàêîí÷èòü(1)
      ÊÎÍÅÖ;
      ìÓòèëü.ÑòðÏàðàì(ñàì_èìÿ, 0);
      ìÓòèëü.ÑòðÏàðàì(óÔàéë.ñòðÈìÿÐàñøèð, 1);
      ìÓòèëü.ÑòðÏàðàì(ÎÑ.ñòðÈìÿ, 2);
      ìÓòèëü.ÑòðÏàðàì(ñòåê.ñòðÐàçìåð, 3);
      ïÂûðàæ := Expr;
      pFactor := Factor;
      pOpSeq := OpSeq;
      ìÑòð.Ðàçäåëèòü(óÔàéë.ñòðÈìÿÐàñøèð, ïóòü, óÔàéë.ñòðÈìÿ, óÔàéë.ñòðÐàñøèð);
      ÅÑËÈ óÔàéë.ñòðÐàñøèð # ìÊîíñò.ðàñøèð ÒÎÃÄÀ
         ìÎø.Ñîîáù(121);
         ìÏðîö.Çàêîí÷èòü(1)
      ÊÎÍÅÖ;
      ìÑòð.Ðàçäåëèòü(ñàì_èìÿ, ñàì_ïóòü, CName, CExt);
      temp := óÔàéë.ñòðÈìÿ;
      ÅÑËÈ ìÑòð.Ñðàâíèòü(ÎÑ.ñòðÈìÿ, "obj") ÒÎÃÄÀ
         ÎÑ.öÊîä := ìÊîíñò.ñèñÎáúåêò;
      ìÑòð.Ñëîæèòü(temp, ".obj", temp)
      ÀÅÑËÈ ìÑòð.Ñðàâíèòü(ÎÑ.ñòðÈìÿ, "elf") ÒÎÃÄÀ
         ÎÑ.öÊîä := ìÊîíñò.ñèñÝëüô;
         felf := ñàì_ïóòü;
         ìÑòð.Ñëîæèòü(felf, "Elf", felf);
         X86.setfelf(felf)
      ÀÅÑËÈ ìÑòð.Ñðàâíèòü(ÎÑ.ñòðÈìÿ, "kos") ÒÎÃÄÀ
         ÎÑ.öÊîä := ìÊîíñò.ñèñÊîëèáðè;
         ìÑòð.Ñëîæèòü(temp, ".kex", temp)
      ÀÅÑËÈ ìÑòð.Ñðàâíèòü(ÎÑ.ñòðÈìÿ, "con") ÒÎÃÄÀ
         ÎÑ.öÊîä := ìÊîíñò.ñèñÌñÊîíñîëü;
         ìÑòð.Ñëîæèòü(temp, ".exe", temp)
      ÀÅÑËÈ ìÑòð.Ñðàâíèòü(ÎÑ.ñòðÈìÿ, "gui") ÒÎÃÄÀ
         ÎÑ.öÊîä := ìÊîíñò.ñèñÌñÎêíî;
         ìÑòð.Ñëîæèòü(temp, ".exe", temp)
      ÀÅÑËÈ ìÑòð.Ñðàâíèòü(ÎÑ.ñòðÈìÿ, "dll") ÒÎÃÄÀ
         ÎÑ.öÊîä := ìÊîíñò.ñèñÌñÄËË;
         ìÑòð.Ñëîæèòü(temp, ".dll", temp)
      ÈÍÀ×Å
         ìÎø.Ñîîáù(ìÎøÊîíñò.îøÎøÏàðàì);
         ìÏðîö.Çàêîí÷èòü(1)
      ÊÎÍÅÖ;
      ÅÑËÈ ÎÑ.öÊîä Â {1,2,3,4} ÒÎÃÄÀ
         ìÑòåê.öÐàçìåð_Óñò(ñòåê)
      ÈÍÀ×Å
         ñòåê.öÐàçìåð := 1
      ÊÎÍÅÖ;
      ÅÑËÈ ÎÑ.öÊîä = 6 ÒÎÃÄÀ
         ñòåê.öÐàçìåð := getver()
      ÊÎÍÅÖ;
      ìÑòð.Ñëîæèòü(ñàì_ïóòü, "Lib", ñàì_ïóòü);
      ìÑòð.Ñëîæèòü(ñàì_ïóòü, ìÊîíñò.ñëýø, ñàì_ïóòü);
      ÅÑËÈ ÎÑ.öÊîä = 5 ÒÎÃÄÀ
         ìÑòð.Ñëîæèòü(ñàì_ïóòü, "Linux32", ñàì_ïóòü)
      ÀÅÑËÈ ÎÑ.öÊîä Â {4, 6} ÒÎÃÄÀ
         ìÑòð.Ñëîæèòü(ñàì_ïóòü, "KolibriOS", ñàì_ïóòü)
      ÀÅÑËÈ ÎÑ.öÊîä Â {1, 2, 3} ÒÎÃÄÀ
         ìÑòð.Ñëîæèòü(ñàì_ïóòü, "Windows32", ñàì_ïóòü)
      ÊÎÍÅÖ;
      ìÑòð.Ñëîæèòü(ñàì_ïóòü, ìÊîíñò.ñëýø, ñàì_ïóòü);
      X86.Íàñòðîèòü(ìÏàì.Ìàëî, ÎÑ.öÊîä);
      X86.Prolog(temp);
      ìÄåöë.Êîä_Íàñòðîèòü(ñàì_ïóòü, ïóòü, óÔàéë.ñòðÈìÿ, óÔàéë.ñòðÐàñøèð, ÎÑ.öÊîä Â {1, 2, 3}, OpSeq, Expr, AssComp, sttypes);
      ìÄåöë.Êîìïèëèðîâàòü(ÎÑ.öÊîä, ñòåê.öÐàçìåð);
      ìÂèíÊîíñ.Öâåò_Óñò(ìÂèíÊîíñ.áåëûé, ìÂèíÊîíñ.ñèíèé);
      ìÊîíñ.Ñòðîêà_Ïå÷àòü("   +Êîìïèëÿöèÿ óñïåøíà!"); ìÊîíñ.ÍîâÑòð;
      ìÂèíÊîíñ.Öâåò_Óñò(ìÂèíÊîíñ.ñâÆ¸ëòûé, ìÂèíÊîíñ.÷¸ðíûé);
      ìÊîíñ.Âðåìÿ_Çàòðà÷åíî;
      ìÂèíÊîíñ.Öâåò_Óñò(ìÂèíÊîíñ.áåëûé, ìÂèíÊîíñ.÷¸ðíûé)
   ÊÎÍÅÖ Ñòàðò;

ÍÀ×ÀËÎ
   Ñòàðò
ÊÎÍÅÖ Compiler.
